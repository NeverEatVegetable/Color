{"version":3,"sources":["file:///E:/CocosProjects/Color/assets/ts-gameframework-master/servers/src/shared/tsgfServer/match/AppMatchRequestHandler.ts"],"names":["AppMatchRequestHandler","MatcherRequests","buildRoomJoinUsMatchRequest","EMatchProcType","ErrorCodes","Result","EMatchFromType","ERoomRegChangedType","arrRemoveItems","arrSum","logger","ERoomCreateType","teamPlayerIdsAdd","teamPlayerIdsAddSingle","teamPlayerIdsSubtractSingle","constructor","appId","reqHelper","gameClusterTerminal","matchers","Map","allMatcherReqs","allReqs","roomRegInfos","roomJoinUsReq","pollMatchReqHd","pollProcTimeoutMatchReqHd","listenMatchProc","proc","onNewAppMatchProc","startPollProcTimeoutReqs","dispose","stopListenMatchProc","stopPollReqs","roomRegInfoChanged","regRoomChanged","get","regInfo","roomId","changedType","Create","set","ChangeInfo","Delete","delete","removeMatchRequestAndResult","PlayerJoinRoom","fromInfo","matchFromInfo","teamsPlayerIds","joinRoomPlayerId","teamId","currPlayerCount","t","playerIds","length","PlayerLeaveRoom","leaveRoomPlayerId","PlayerChangeTeam","changePlayerId","oldTeamId","newTeamId","clearTimeout","startPollAllReqs","setTimeout","pollAllReqs","pollProcTimeoutReqs","size","matcherKey","matcherReqs","matcher","log","result","onPollMatcherReqs","slice","procMatcherExecResult","addNewMatchReq","matchReq","startMatchTime","Date","now","matchReqId","matcherAllReqs","push","matchFromType","RoomJoinUs","existsJoinUsReq","faildMatchRequest","MatchRequestCancelled","stopPollProcTimeoutReqs","timeoutReqIds","keys","i","req","matchTimeoutSec","faildMatchRequests","MatchTimeout","matchProc","procType","RequestMatch","onNewAppMatchReq","CancelMatch","onCancelMatchReq","getMatchRequest","warn","MatchMatcherNotFound","ParamsError","ret","onNewMatchReq","buildErr","setMatchRequestResult","currReq","resultErrCode","resultErrMsg","MatchUnknown","hasResult","error","resultCreateRoom","createRoomResult","matchRequestPlayerResults","createRoomRet","createRoom","createRoomPara","MATCH_CREATE","succ","forEach","reqPlayerResult","find","r","err","code","roomOnlineInfo","data","matchTeamsPlayerIds","firstReq","playerRet","matchPlayerResults","playerId","matchResult","gameServerUrl","succMatchRequest","roomJoinUsMatch","useReq","resultJoinRoom","joinRoomResult","getRoomOLInfo","getRoomOnlineInfo","joinRoomId","errMsg","errCode","buildSucc","succMatchRequests"],"mappings":";;;6QAiBaA,sB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAfJC,MAAAA,e,iBAAAA,e;;AACAC,MAAAA,2B,iBAAAA,2B;AAA6BC,MAAAA,c,iBAAAA,c;;AAE7BC,MAAAA,U,iBAAAA,U;AAAqBC,MAAAA,M,iBAAAA,M;;AACrBC,MAAAA,c,iBAAAA,c;;AACAC,MAAAA,mB,iBAAAA,mB;;AACAC,MAAAA,c,iBAAAA,c;AAAgBC,MAAAA,M,iBAAAA,M;;AAChBC,MAAAA,M,iBAAAA,M;;AACAC,MAAAA,e,iBAAAA,e;;AACcC,MAAAA,gB,kBAAAA,gB;AAAkBC,MAAAA,sB,kBAAAA,sB;AAAwBC,MAAAA,2B,kBAAAA,2B;;;;;;;AAKjE;wCACad,sB,GAAN,MAAMA,sBAAN,CAA6B;AAsBhC;AACJ;AACA;AACA;AACA;AACA;AACIe,QAAAA,WAAW,CAACC,KAAD,EAAgBC,SAAhB,EAA+CC,mBAA/C,EAAyF;AAAA,eA1B7FF,KA0B6F;;AAzBpG;AAyBoG,eAxB7FG,QAwB6F,GAxB3D,IAAIC,GAAJ,EAwB2D;;AAvBpG;AAuBoG,eAtB7FC,cAsB6F,GAtB9C,IAAID,GAAJ,EAsB8C;;AArBpG;AAqBoG,eApB7FE,OAoB6F,GApBvD,IAAIF,GAAJ,EAoBuD;;AAnBpG;AAmBoG,eAlB7FH,SAkB6F;;AAhBpG;AAgBoG,eAf7FM,YAe6F,GAfnD,IAAIH,GAAJ,EAemD;;AAdpG;AAcoG,eAb7FI,aAa6F,GAbjD,IAAIJ,GAAJ,EAaiD;AAAA,eAX7FF,mBAW6F;AAAA,eAT1FO,cAS0F,GATpE,IASoE;AAAA,eAR1FC,yBAQ0F,GARzD,IAQyD;AAChG,eAAKV,KAAL,GAAaA,KAAb;AACA,eAAKC,SAAL,GAAiBA,SAAjB;AACA,eAAKA,SAAL,CAAeU,eAAf,CAA+B,KAAKX,KAApC,EAA2C,MAAOY,IAAP,IAAgB;AACvD,kBAAM,KAAKC,iBAAL,CAAuBD,IAAvB,CAAN;AACH,WAFD;AAGA,eAAKV,mBAAL,GAA2BA,mBAA3B;AACA,eAAKY,wBAAL;AACH;AACD;AACJ;AACA;AACA;AACA;;;AACWC,QAAAA,OAAO,GAAG;AACb,eAAKd,SAAL,CAAee,mBAAf,CAAmC,KAAKhB,KAAxC;AACA,eAAKiB,YAAL;AACA,eAAKH,wBAAL;AACH;;AAEMI,QAAAA,kBAAkB,CAACC,cAAD,EAAkC;AACvD,cAAIX,aAAa,GAAG,KAAKA,aAAL,CAAmBY,GAAnB,CAAuBD,cAAc,CAACE,OAAf,CAAuBC,MAA9C,CAApB;;AACA,kBAAQH,cAAc,CAACI,WAAvB;AACI,iBAAK;AAAA;AAAA,4DAAoBC,MAAzB;AACI,mBAAKjB,YAAL,CAAkBkB,GAAlB,CAAsBN,cAAc,CAACE,OAAf,CAAuBC,MAA7C,EAAqDH,cAAc,CAACE,OAApE;AACA;;AACJ,iBAAK;AAAA;AAAA,4DAAoBK,UAAzB;AACI,mBAAKnB,YAAL,CAAkBkB,GAAlB,CAAsBN,cAAc,CAACE,OAAf,CAAuBC,MAA7C,EAAqDH,cAAc,CAACE,OAApE;AACA;;AACJ,iBAAK;AAAA;AAAA,4DAAoBM,MAAzB;AACI,mBAAKpB,YAAL,CAAkBqB,MAAlB,CAAyBT,cAAc,CAACE,OAAf,CAAuBC,MAAhD;;AACA,kBAAId,aAAJ,EAAmB;AACf;AACA,qBAAKqB,2BAAL,CAAiCrB,aAAjC;AACH;;AACD;;AACJ,iBAAK;AAAA;AAAA,4DAAoBsB,cAAzB;AACI,kBAAItB,aAAJ,EAAmB;AACf;AACA,oBAAIuB,QAAQ,GAAGvB,aAAa,CAACwB,aAA7B;AACA;AAAA;AAAA,sEAAuBD,QAAQ,CAACE,cAAhC,EACId,cAAc,CAACe,gBADnB,EACqCf,cAAc,CAACgB,MADpD;AAEAJ,gBAAAA,QAAQ,CAACK,eAAT,GAA2B;AAAA;AAAA,sCAAOL,QAAQ,CAACE,cAAhB,EAAgCI,CAAC,IAAIA,CAAC,CAACC,SAAF,CAAYC,MAAjD,CAA3B;AACH;;AACD;;AACJ,iBAAK;AAAA;AAAA,4DAAoBC,eAAzB;AACI,kBAAIhC,aAAJ,EAAmB;AACf;AACA,oBAAIuB,QAAQ,GAAGvB,aAAa,CAACwB,aAA7B;AACA;AAAA;AAAA,gFAA4BD,QAAQ,CAACE,cAArC,EACId,cAAc,CAACsB,iBADnB,EACsCtB,cAAc,CAACgB,MADrD;AAEAJ,gBAAAA,QAAQ,CAACK,eAAT,GAA2B;AAAA;AAAA,sCAAOL,QAAQ,CAACE,cAAhB,EAAgCI,CAAC,IAAIA,CAAC,CAACC,SAAF,CAAYC,MAAjD,CAA3B;AACH;;AACD;;AACJ,iBAAK;AAAA;AAAA,4DAAoBG,gBAAzB;AACI,kBAAIlC,aAAJ,EAAmB;AACf;AACA,oBAAIuB,QAAQ,GAAGvB,aAAa,CAACwB,aAA7B;AACA;AAAA;AAAA,gFAA4BD,QAAQ,CAACE,cAArC,EACId,cAAc,CAACwB,cADnB,EACmCxB,cAAc,CAACyB,SADlD;AAEA;AAAA;AAAA,sEAAuBb,QAAQ,CAACE,cAAhC,EACId,cAAc,CAACwB,cADnB,EACmCxB,cAAc,CAAC0B,SADlD;AAEAd,gBAAAA,QAAQ,CAACK,eAAT,GAA2B;AAAA;AAAA,sCAAOL,QAAQ,CAACE,cAAhB,EAAgCI,CAAC,IAAIA,CAAC,CAACC,SAAF,CAAYC,MAAjD,CAA3B;AACH;;AACD;AA1CR;AA4CH;AAGD;;;AACUtB,QAAAA,YAAY,GAAG;AACrB,cAAI,KAAKR,cAAT,EAAyBqC,YAAY,CAAC,KAAKrC,cAAN,CAAZ;AACzB,eAAKA,cAAL,GAAsB,IAAtB;AACH;AACD;;;AACUsC,QAAAA,gBAAgB,GAAG;AACzB,eAAK9B,YAAL;AACA,eAAKR,cAAL,GAAsBuC,UAAU,CAAC,YAAY,MAAM,KAAKC,WAAL,EAAnB,EAAuC,IAAvC,CAAhC;AACH;AACD;;;AAC2B,cAAXA,WAAW,GAAkB;AACzC;AACA,gBAAM,KAAKC,mBAAL,EAAN;;AAEA,cAAI,KAAK7C,cAAL,CAAoB8C,IAApB,GAA2B,CAA/B,EAAkC;AAC9B,iBAAK,IAAI,CAACC,UAAD,EAAaC,WAAb,CAAT,IAAsC,KAAKhD,cAA3C,EAA2D;AACvD,kBAAIiD,OAAO,GAAG,KAAKnD,QAAL,CAAciB,GAAd,CAAkBgC,UAAlB,CAAd;AACA,kBAAI,CAACE,OAAD,IAAYD,WAAW,CAACd,MAAZ,IAAsB,CAAtC,EAAyC;AACzC;AAAA;AAAA,oCAAOgB,GAAP,CAAW,oBAAX,EAAkC,gBAAeD,OAAO,CAACF,UAAW,qBAAoBC,WAAW,CAACd,MAAO,EAA3G;AACA,kBAAIiB,MAAM,GAAGF,OAAO,CAACG,iBAAR,CAA0BJ,WAAW,CAACK,KAAZ,EAA1B,CAAb;AACA,oBAAM,KAAKC,qBAAL,CAA2BH,MAA3B,EAAmCH,WAAnC,CAAN;AACH;AACJ,WAZwC,CAazC;;;AACA,eAAKN,gBAAL;AACH;AAED;;;AAC8B,cAAda,cAAc,CAACC,QAAD,EAAoD;AAC9E;AACAA,UAAAA,QAAQ,CAACC,cAAT,GAA0BC,IAAI,CAACC,GAAL,EAA1B,CAF8E,CAG9E;;AACA,eAAK1D,OAAL,CAAamB,GAAb,CAAiBoC,QAAQ,CAACI,UAA1B,EAAsCJ,QAAtC,EAJ8E,CAK9E;;AACA,cAAIK,cAAc,GAAG,KAAK7D,cAAL,CAAoBe,GAApB,CAAwByC,QAAQ,CAACT,UAAjC,CAArB;;AACA,cAAI,CAACc,cAAL,EAAqB;AACjBA,YAAAA,cAAc,GAAG;AAAA;AAAA,oDAAoBL,QAAQ,CAACT,UAA7B,CAAjB;AACA,iBAAK/C,cAAL,CAAoBoB,GAApB,CAAwByC,cAAc,CAACd,UAAvC,EAAmDc,cAAnD;AACH;;AACDA,UAAAA,cAAc,CAACC,IAAf,CAAoBN,QAApB;;AAEA,cAAIA,QAAQ,CAACO,aAAT,KAA2B;AAAA;AAAA,gDAAeC,UAA9C,EAA0D;AACtD;AACA,gBAAIC,eAAe,GAAG,KAAK9D,aAAL,CAAmBY,GAAnB,CAAuByC,QAAQ,CAAC7B,aAAT,CAAuBV,MAA9C,CAAtB;;AACA,gBAAIgD,eAAJ,EAAqB;AACjB;AACA,oBAAM,KAAKC,iBAAL,CAAuBD,eAAvB,EAAyC,cAAzC,EAAwD;AAAA;AAAA,4CAAWE,qBAAnE,EAA0FN,cAA1F,CAAN;AACH,aANqD,CAOtD;;;AACA,iBAAK1D,aAAL,CAAmBiB,GAAnB,CAAuBoC,QAAQ,CAAC7B,aAAT,CAAuBV,MAA9C,EAAsDuC,QAAtD;AACH;;AAED,iBAAOK,cAAP;AACH;;AAESO,QAAAA,uBAAuB,GAAG;AAChC,cAAI,KAAK/D,yBAAT,EAAoCoC,YAAY,CAAC,KAAKpC,yBAAN,CAAZ;AACpC,eAAKA,yBAAL,GAAiC,IAAjC;AACH;;AACSI,QAAAA,wBAAwB,GAAG;AACjC,eAAK2D,uBAAL;AACA,eAAK/D,yBAAL,GAAiCsC,UAAU,CAAC,YAAY,MAAM,KAAKE,mBAAL,EAAnB,EAA+C,IAA/C,CAA3C;AACH;AACD;;;AACmC,cAAnBA,mBAAmB,GAAkB;AACjD,cAAI,KAAK7C,cAAL,CAAoB8C,IAApB,GAA2B,CAA/B,EAAkC;AAC9B,gBAAIa,GAAG,GAAGD,IAAI,CAACC,GAAL,EAAV;AACA,gBAAIU,aAA8B,GAAG,EAArC;;AACA,iBAAK,IAAItB,UAAT,IAAuB,KAAK/C,cAAL,CAAoBsE,IAApB,EAAvB,EAAmD;AAC/C,kBAAItB,WAAW,GAAG,KAAKhD,cAAL,CAAoBe,GAApB,CAAwBgC,UAAxB,CAAlB;AACA,kBAAIE,OAAO,GAAG,KAAKnD,QAAL,CAAciB,GAAd,CAAkBgC,UAAlB,CAAd;AACA,kBAAI,CAACE,OAAD,IAAY,CAACD,WAAb,IAA4BA,WAAW,CAACd,MAAZ,IAAsB,CAAtD,EAAyD;;AACzD,mBAAK,IAAIqC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGvB,WAAW,CAACd,MAAhC,EAAwCqC,CAAC,EAAzC,EAA6C;AACzC,oBAAIC,GAAG,GAAGxB,WAAW,CAACuB,CAAD,CAArB;AACA,oBAAI,CAACC,GAAG,CAACC,eAAT,EAA0B;;AAC1B,oBAAID,GAAG,CAACf,cAAJ,GAAqBe,GAAG,CAACC,eAAJ,GAAsB,IAA3C,GAAkDd,GAAtD,EAA2D;AACvD;AACAU,kBAAAA,aAAa,CAACP,IAAd,CAAmBU,GAAnB;AACH;AACJ;AACJ;;AACD,gBAAIH,aAAa,CAACnC,MAAd,GAAuB,CAA3B,EAA8B;AAC1B,oBAAM,KAAKwC,kBAAL,CAAwBL,aAAxB,EAAuC,OAAvC,EAAgD;AAAA;AAAA,4CAAWM,YAA3D,CAAN;AACH;AACJ,WApBgD,CAsBjD;;;AACA,eAAKlE,wBAAL;AACH;AAED;;;AACiC,cAAjBD,iBAAiB,CAACoE,SAAD,EAAwB;AACrD,cAAIA,SAAS,CAACC,QAAV,KAAuB;AAAA;AAAA,gDAAeC,YAA1C,EAAwD;AACpD;AACA,mBAAO,MAAM,KAAKC,gBAAL,CAAsBH,SAAS,CAAChB,UAAhC,CAAb;AACH,WAHD,MAGO,IAAIgB,SAAS,CAACC,QAAV,KAAuB;AAAA;AAAA,gDAAeG,WAA1C,EAAuD;AAC1D;AACA,mBAAO,MAAM,KAAKC,gBAAL,CAAsBL,SAAS,CAAChB,UAAhC,CAAb;AACH;AACJ;;AAC+B,cAAhBmB,gBAAgB,CAACnB,UAAD,EAAqB;AACjD,cAAIJ,QAAQ,GAAG,MAAM,KAAK5D,SAAL,CAAesF,eAAf,CAA+B,KAAKvF,KAApC,EAA2CiE,UAA3C,CAArB;;AACA,cAAI,CAACJ,QAAL,EAAe;AACX;AACA;AAAA;AAAA,kCAAO2B,IAAP,CAAY,oBAAZ,EAAkC,YAAlC,EAAgD,KAAKxF,KAArD,EAA4DiE,UAA5D;AACA;AACH;;AACD,cAAIX,OAAO,GAAG,KAAKnD,QAAL,CAAciB,GAAd,CAAkByC,QAAQ,CAACT,UAA3B,CAAd;;AACA,cAAI,CAACE,OAAL,EAAc;AACV;AACA,mBAAO,MAAM,KAAKiB,iBAAL,CAAuBV,QAAvB,EAAkC,aAAYA,QAAQ,CAACT,UAAW,EAAlE,EAAqE;AAAA;AAAA,0CAAWqC,oBAAhF,CAAb;AACH;;AACD,cAAI5B,QAAQ,CAACO,aAAT,KAA2B;AAAA;AAAA,gDAAeC,UAA9C,EAA0D;AACtD;AACA,gBAAI,CAACR,QAAQ,CAAC7B,aAAT,CAAuBV,MAA5B,EAAoC;AAChC,qBAAO,MAAM,KAAKiD,iBAAL,CAAuBV,QAAvB,EAAkC,2BAAlC,EAA8D;AAAA;AAAA,4CAAW6B,WAAzE,CAAb;AACH;AACJ,WAjBgD,CAmBjD;;;AACA,cAAIxB,cAAc,GAAG,MAAM,KAAKN,cAAL,CAAoBC,QAApB,CAA3B,CApBiD,CAsBjD;;AACA,eAAK5C,YAAL,GAvBiD,CAyBjD;;AACA;AAAA;AAAA,gCAAOsC,GAAP,CAAW,oBAAX,EAAkC,iBAAgBD,OAAO,CAACF,UAAW,qBAAoBc,cAAc,CAAC3B,MAAO,EAA/G;AACA,cAAIoD,GAAG,GAAGrC,OAAO,CAACsC,aAAR,CAAsB/B,QAAtB,EAAgCK,cAAc,CAACR,KAAf,EAAhC,CAAV;AACA,gBAAM,KAAKC,qBAAL,CAA2BgC,GAA3B,EAAgCzB,cAAhC,EAAgDL,QAAhD,CAAN,CA5BiD,CA8BjD;;AACA,eAAKd,gBAAL;AAEH;;AAC+B,cAAhBuC,gBAAgB,CAACrB,UAAD,EAAqB;AACjD,cAAIJ,QAA0C,GAAG,KAAKvD,OAAL,CAAac,GAAb,CAAiB6C,UAAjB,CAAjD;;AACA,cAAI,CAACJ,QAAL,EAAe;AACX;AACAA,YAAAA,QAAQ,GAAG,MAAM,KAAK5D,SAAL,CAAesF,eAAf,CAA+B,KAAKvF,KAApC,EAA2CiE,UAA3C,CAAjB;;AACA,gBAAI,CAACJ,QAAL,EAAe;AACX;AACA;AACH;AACJ;;AACD,cAAIR,WAAW,GAAG,KAAKhD,cAAL,CAAoBe,GAApB,CAAwByC,QAAQ,CAACT,UAAjC,CAAlB;;AACA,cAAI,CAACC,WAAL,EAAkB;AACdA,YAAAA,WAAW,GAAG;AAAA;AAAA,oDAAoBQ,QAAQ,CAACT,UAA7B,CAAd;AACA,iBAAK/C,cAAL,CAAoBoB,GAApB,CAAwB4B,WAAW,CAACD,UAApC,EAAgDC,WAAhD;AACH;;AAED,cAAIG,MAAM,GAAG;AAAA;AAAA,gCAAOqC,QAAP,CAA8B,OAA9B,EAAuC;AAAA;AAAA,wCAAWrB,qBAAlD,CAAb;AACA,eAAKsB,qBAAL,CAA2BjC,QAA3B,EAAqCL,MAArC,EAA6CH,WAA7C;AACH;AAID;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACyC,cAArBM,qBAAqB,CAACH,MAAD,EAA6BU,cAA7B,EAA+D6B,OAA/D,EAAuG;AACxI,cAAIvC,MAAM,CAACwC,aAAP,IAAwBxC,MAAM,CAACyC,YAAnC,EAAiD;AAAA;;AAC7CzC,YAAAA,MAAM,CAACyC,YAAP,2BAAsBzC,MAAM,CAACyC,YAA7B,mCAA6C,MAA7C;AACAzC,YAAAA,MAAM,CAACwC,aAAP,4BAAuBxC,MAAM,CAACwC,aAA9B,oCAA+C;AAAA;AAAA,0CAAWE,YAA1D,CAF6C,CAG7C;;AACA,gBAAIH,OAAJ,EAAa;AACT,mBAAKxB,iBAAL,CAAuBwB,OAAvB,EAAgCvC,MAAM,CAACyC,YAAvC,EAAqDzC,MAAM,CAACwC,aAA5D;AACA;AACH;;AACD,gBAAI9B,cAAJ,EAAoB;AAChB,mBAAK,IAAIW,GAAT,IAAgBX,cAAhB,EAAgC;AAC5B,qBAAKK,iBAAL,CAAuBM,GAAvB,EAA4BrB,MAAM,CAACyC,YAAnC,EAAiDzC,MAAM,CAACwC,aAAxD;AACH;;AACD;AACH;;AACD;AACH;;AACD,cAAI,CAACxC,MAAM,CAAC2C,SAAZ,EAAuB;AACnB;AACA;AACH;;AAED,cAAI,CAACjC,cAAL,EAAqB;AACjB;AACA;AAAA;AAAA,kCAAOkC,KAAP,CAAc,+DAAd;AACA;AACH;;AAED,cAAI5C,MAAM,CAAC6C,gBAAX,EAA6B;AACzB;AACA,iBAAK,IAAIC,gBAAT,IAA6B9C,MAAM,CAAC6C,gBAApC,EAAsD;AAClD,kBAAIC,gBAAgB,CAACC,yBAAjB,CAA2ChE,MAA3C,IAAqD,CAAzD,EAA4D;AAC5D,kBAAIiE,aAAa,GAAG,MAAM,KAAKtG,mBAAL,CAAyBuG,UAAzB,CACtB,KAAKzG,KADiB,EACVsG,gBAAgB,CAACI,cADP,EACuB;AAAA;AAAA,sDAAgBC,YADvC,CAA1B;;AAEA,kBAAI,CAACH,aAAa,CAACI,IAAnB,EAAyB;AACrBN,gBAAAA,gBAAgB,CAACC,yBAAjB,CAA2CM,OAA3C,CAAmD,MAAMC,eAAN,IAAyB;AACxE,sBAAIjC,GAAG,GAAGX,cAAc,CAAC6C,IAAf,CAAoBC,CAAC,IAAIA,CAAC,CAAC/C,UAAF,KAAiB6C,eAAe,CAAC7C,UAA1D,CAAV;AACA,sBAAI,CAACY,GAAL,EAAU;AACV,wBAAM,KAAKN,iBAAL,CAAuBM,GAAvB,EAA4B2B,aAAa,CAACS,GAA1C,EAAgDT,aAAa,CAACU,IAA9D,CAAN;AACH,iBAJD;AAKA;AACH;;AAED,kBAAIC,cAAc,GAAGX,aAAa,CAACY,IAAnC;AAEA,kBAAIC,mBAAqC,GAAG,EAA5C;AACA,kBAAIC,QAAJ,CAhBkD,CAiBlD;;AACA,mBAAK,IAAIR,eAAT,IAA4BR,gBAAgB,CAACC,yBAA7C,EAAwE;AACpE,oBAAI1B,GAAG,GAAGX,cAAc,CAAC6C,IAAf,CAAoBC,CAAC,IAAIA,CAAC,CAAC/C,UAAF,KAAiB6C,eAAe,CAAC7C,UAA1D,CAAV;AACA,oBAAI,CAACY,GAAL,EAAU;AACV,oBAAI,CAACyC,QAAL,EAAeA,QAAQ,GAAGzC,GAAX;;AAEf,qBAAK,IAAI0C,SAAT,IAAsBT,eAAe,CAACU,kBAAtC,EAA0D;AACtD;AAAA;AAAA,wEAAuBH,mBAAvB,EAA4CE,SAAS,CAACE,QAAtD,EAAgEF,SAAS,CAACpF,MAA1E;AACH;;AACD,oBAAIuF,WAAyB,GAAG;AAC5BpG,kBAAAA,MAAM,EAAE6F,cAAc,CAAC7F,MADK;AAE5BqG,kBAAAA,aAAa,EAAER,cAAc,CAACQ,aAFF;AAG5BH,kBAAAA,kBAAkB,EAAEV,eAAe,CAACU;AAHR,iBAAhC;AAKA,sBAAM,KAAKI,gBAAL,CAAsB/C,GAAtB,EAA2B6C,WAA3B,EAAwCxD,cAAxC,CAAN;AACH;;AAED,kBAAIoC,gBAAgB,CAACuB,eAArB,EAAsC;AAClC;AACA;AACA,oBAAIC,MAAM,GAAGR,QAAb;AACA,oBAAI9G,aAAa,GACb;AAAA;AAAA,gFAA4BsH,MAA5B,EAAoCX,cAAc,CAAC7F,MAAnD,EAA2D+F,mBAA3D,CADJ;AAEA,sBAAM,KAAKzD,cAAL,CAAoBpD,aAApB,CAAN;AACH;AACJ;AACJ;;AAED,cAAIgD,MAAM,CAACuE,cAAX,EAA2B;AACvB;AACA,iBAAK,IAAIC,cAAT,IAA2BxE,MAAM,CAACuE,cAAlC,EAAkD;AAC9C;AACA,kBAAIE,aAAa,GAAG,MAAM,KAAK/H,mBAAL,CAAyBgI,iBAAzB,CAA2CF,cAAc,CAACG,UAA1D,CAA1B;;AACA,kBAAI,CAACF,aAAa,CAACrB,IAAnB,EAAyB;AACrBoB,gBAAAA,cAAc,CAACzB,yBAAf,CAAyCM,OAAzC,CAAiD,MAAMC,eAAN,IAAyB;AACtE,sBAAIjC,GAAG,GAAGX,cAAc,CAAC6C,IAAf,CAAoBC,CAAC,IAAIA,CAAC,CAAC/C,UAAF,KAAiB6C,eAAe,CAAC7C,UAA1D,CAAV;AACA,sBAAI,CAACY,GAAL,EAAU,OAF4D,CAGtE;;AACA,wBAAM,KAAKN,iBAAL,CAAuBM,GAAvB,EAA4BoD,aAAa,CAAChB,GAA1C,EAAgDgB,aAAa,CAACf,IAA9D,CAAN;AACH,iBALD;AAMA;AACH,eAX6C,CAY9C;;;AACA,kBAAIG,mBAAqC,GAAG,EAA5C,CAb8C,CAe9C;;AACA,mBAAK,IAAIP,eAAT,IAA4BkB,cAAc,CAACzB,yBAA3C,EAAsE;AAClE,oBAAI1B,GAAG,GAAGX,cAAc,CAAC6C,IAAf,CAAoBC,CAAC,IAAIA,CAAC,CAAC/C,UAAF,KAAiB6C,eAAe,CAAC7C,UAA1D,CAAV;AACA,oBAAI,CAACY,GAAL,EAAU;;AACV,qBAAK,IAAI0C,SAAT,IAAsBT,eAAe,CAACU,kBAAtC,EAA0D;AACtD;AAAA;AAAA,wEAAuBH,mBAAvB,EAA4CE,SAAS,CAACE,QAAtD,EAAgEF,SAAS,CAACpF,MAA1E;AACH;;AACD,oBAAIuF,WAAyB,GAAG;AAC5BpG,kBAAAA,MAAM,EAAE0G,cAAc,CAACG,UADK;AAE5BR,kBAAAA,aAAa,EAAEM,aAAa,CAACb,IAAd,CAAmBO,aAFN;AAG5BH,kBAAAA,kBAAkB,EAAEV,eAAe,CAACU;AAHR,iBAAhC;AAKA,sBAAM,KAAKI,gBAAL,CAAsB/C,GAAtB,EAA2B6C,WAA3B,EAAwCxD,cAAxC,CAAN;AACH;;AAED,kBAAI2D,eAAe,GAAG,KAAKrH,aAAL,CAAmBY,GAAnB,CAAuB4G,cAAc,CAACG,UAAtC,CAAtB;;AACA,kBAAIN,eAAJ,EAAqB;AACjB;AACA,oBAAI9F,QAAQ,GAAG8F,eAAe,CAAC7F,aAA/B,CAFiB,CAGjB;;AACA;AAAA;AAAA,0DAAiBD,QAAQ,CAACE,cAA1B,EAA0CoF,mBAA1C;;AACA,oBAAI,CAACW,cAAc,CAACH,eAApB,EAAqC;AACjC;AACA,uBAAKhG,2BAAL,CAAiCgG,eAAjC;AACH;AACJ;AACJ;AACJ;AAEJ;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACyC,cAArB/B,qBAAqB,CAACjC,QAAD,EAA0BL,MAA1B,EAAyDU,cAAzD,EAA6G;AAC9I,cAAI,CAACA,cAAL,EAAqB;AACjBA,YAAAA,cAAc,GAAG,KAAK7D,cAAL,CAAoBe,GAApB,CAAwByC,QAAQ,CAACT,UAAjC,CAAjB;AACH;;AACD,cAAIc,cAAJ,EAAoB;AAChB;AACA;AAAA;AAAA,kDAAeA,cAAf,EAA+B8C,CAAC,IAAIA,CAAC,CAAC/C,UAAF,KAAiBJ,QAAQ,CAACI,UAA9D;AACH,WAP6I,CAQ9I;;;AACA,eAAK3D,OAAL,CAAasB,MAAb,CAAoBiC,QAAQ,CAACI,UAA7B,EAT8I,CAU9I;;AACA,cAAIJ,QAAQ,CAACO,aAAT,KAA2B;AAAA;AAAA,gDAAeC,UAA9C,EAA0D;AACtD,iBAAK7D,aAAL,CAAmBoB,MAAnB,CAA0BiC,QAAQ,CAAC7B,aAAT,CAAuBV,MAAjD;AACH,WAb6I,CAc9I;;;AACA,iBAAO,MAAM,KAAKrB,SAAL,CAAe6F,qBAAf,CAAqC,KAAK9F,KAA1C,EAAiD6D,QAAjD,EAA2DL,MAA3D,CAAb;AACH;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;;;AAC+C,cAA3B3B,2BAA2B,CAACgC,QAAD,EAA0BK,cAA1B,EAA2E;AAClH,cAAI,CAACA,cAAL,EAAqB;AACjBA,YAAAA,cAAc,GAAG,KAAK7D,cAAL,CAAoBe,GAApB,CAAwByC,QAAQ,CAACT,UAAjC,CAAjB;AACH;;AACD,cAAIc,cAAJ,EAAoB;AAChB;AACA;AAAA;AAAA,kDAAeA,cAAf,EAA+B8C,CAAC,IAAIA,CAAC,CAAC/C,UAAF,KAAiBJ,QAAQ,CAACI,UAA9D;AACH,WAPiH,CAQlH;;;AACA,eAAK3D,OAAL,CAAasB,MAAb,CAAoBiC,QAAQ,CAACI,UAA7B,EATkH,CAUlH;;AACA,cAAIJ,QAAQ,CAACO,aAAT,KAA2B;AAAA;AAAA,gDAAeC,UAA9C,EAA0D;AACtD,iBAAK7D,aAAL,CAAmBoB,MAAnB,CAA0BiC,QAAQ,CAAC7B,aAAT,CAAuBV,MAAjD;AACH,WAbiH,CAclH;;;AACA,iBAAO,MAAM,KAAKrB,SAAL,CAAe4B,2BAAf,CAA2C,KAAK7B,KAAhD,EAAuD6D,QAAQ,CAACI,UAAhE,CAAb;AACH;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACkC,cAAjBM,iBAAiB,CAACV,QAAD,EAA0BuE,MAA1B,EAA0CC,OAA1C,EAA2DnE,cAA3D,EAA4G;AACtI,gBAAM,KAAK4B,qBAAL,CAA2BjC,QAA3B,EAAqC;AAAA;AAAA,gCAAOgC,QAAP,CAAgBuC,MAAhB,EAAwBC,OAAxB,CAArC,EAAuEnE,cAAvE,CAAN;AACH;AACD;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACmC,cAAlBa,kBAAkB,CAAC1B,WAAD,EAAoC+E,MAApC,EAAoDC,OAApD,EAAqEnE,cAArE,EAAsH;AACjJ,eAAK,IAAIW,GAAT,IAAgBxB,WAAhB,EAA6B;AACzB,kBAAM,KAAKyC,qBAAL,CAA2BjB,GAA3B,EAAgC;AAAA;AAAA,kCAAOgB,QAAP,CAAgBuC,MAAhB,EAAwBC,OAAxB,CAAhC,EAAkEnE,cAAlE,CAAN;AACH;AACJ;AACD;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACiC,cAAhB0D,gBAAgB,CAAC/D,QAAD,EAA0BL,MAA1B,EAAgDU,cAAhD,EAAiG;AAC1H,gBAAM,KAAK4B,qBAAL,CAA2BjC,QAA3B,EAAqC;AAAA;AAAA,gCAAOyE,SAAP,CAAiB9E,MAAjB,CAArC,EAA+DU,cAA/D,CAAN;AACH;AACD;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACkC,cAAjBqE,iBAAiB,CAAClF,WAAD,EAAoCG,MAApC,EAA0DU,cAA1D,EAA2G;AACrI,eAAK,IAAIW,GAAT,IAAgBxB,WAAhB,EAA6B;AACzB,kBAAM,KAAKyC,qBAAL,CAA2BjB,GAA3B,EAAgC;AAAA;AAAA,kCAAOyD,SAAP,CAAiB9E,MAAjB,CAAhC,EAA0DU,cAA1D,CAAN;AACH;AACJ;;AA5e+B,O","sourcesContent":["\nimport { IMatcher } from \"./IMatcher\";\nimport { MatcherRequests } from \"./MatcherRequests\";\nimport { buildRoomJoinUsMatchRequest, EMatchProcType, IMatcherExecResult, IMatchFromRoomJoinUsOnServer, IMatchProc, IMatchRequest } from \"./Models\";\nimport { MatchRequestHelper } from \"./MatchRequestHelper\";\nimport { ErrorCodes, IResult, Result } from \"../../tsgf/Result\";\nimport { EMatchFromType, IMatchResult } from \"../../tsgf/match/Models\";\nimport { ERoomRegChangedType, IRoomInfoPack, IRoomRegChanged, RoomHelper } from \"../room/RoomHelper\";\nimport { arrRemoveItems, arrSum } from \"../../tsgf/Utils\";\nimport { logger } from \"../../tsgf/logger\";\nimport { ERoomCreateType, ICreateRoomPara, ITeamPlayerIds } from \"../../tsgf/room/IRoomInfo\";\nimport { IRoomRegInfo, teamPlayerIdsAdd, teamPlayerIdsAddSingle, teamPlayerIdsSubtractSingle } from \"../room/Models\";\nimport { IGameServerInfoInServer } from \"../game/Models\";\nimport { GameServerHelper } from \"../game/GameServerHelper\";\nimport { GameClusterTerminal } from \"../gameCluster/GameClusterTerminal\";\n\n/**应用匹配请求处理器*/\nexport class AppMatchRequestHandler {\n\n    public appId: string;\n    /**本应用的所有匹配器，按匹配器标识字典*/\n    public matchers: Map<string, IMatcher> = new Map<string, IMatcher>();\n    /**本应用的所有匹配器下的匹配请求*/\n    public allMatcherReqs: Map<string, MatcherRequests> = new Map<string, MatcherRequests>();\n    /**本应用的所有匹配请求*/\n    public allReqs: Map<string, IMatchRequest> = new Map<string, IMatchRequest>();\n    /**公共的请求处理工具*/\n    public reqHelper: MatchRequestHelper;\n\n    /**本应用下的房间注册信息缓存, 由父级服务进行维护*/\n    public roomRegInfos: Map<string, IRoomRegInfo> = new Map<string, IRoomRegInfo>();\n    /**房间招人的匹配,一个房间只能存在一个匹配请求*/\n    public roomJoinUsReq: Map<string, IMatchRequest> = new Map<string, IMatchRequest>();\n\n    public gameClusterTerminal: GameClusterTerminal;\n\n    protected pollMatchReqHd: any = null;\n    protected pollProcTimeoutMatchReqHd: any = null;\n\n    /**\n     *\n     * @param appId\n     * @param reqHelper 公共的请求工具类\n     * @param allotGameServer 设置一个分配游戏服务器的方法\n     */\n    constructor(appId: string, reqHelper: MatchRequestHelper, gameClusterTerminal: GameClusterTerminal) {\n        this.appId = appId;\n        this.reqHelper = reqHelper;\n        this.reqHelper.listenMatchProc(this.appId, async (proc) => {\n            await this.onNewAppMatchProc(proc);\n        });\n        this.gameClusterTerminal = gameClusterTerminal;\n        this.startPollProcTimeoutReqs();\n    }\n    /**\n     * 清除数据\n     *\n     * @public\n     */\n    public dispose() {\n        this.reqHelper.stopListenMatchProc(this.appId);\n        this.stopPollReqs();\n        this.startPollProcTimeoutReqs();\n    }\n\n    public roomRegInfoChanged(regRoomChanged: IRoomRegChanged) {\n        let roomJoinUsReq = this.roomJoinUsReq.get(regRoomChanged.regInfo.roomId);\n        switch (regRoomChanged.changedType) {\n            case ERoomRegChangedType.Create:\n                this.roomRegInfos.set(regRoomChanged.regInfo.roomId, regRoomChanged.regInfo);\n                break;\n            case ERoomRegChangedType.ChangeInfo:\n                this.roomRegInfos.set(regRoomChanged.regInfo.roomId, regRoomChanged.regInfo);\n                break;\n            case ERoomRegChangedType.Delete:\n                this.roomRegInfos.delete(regRoomChanged.regInfo.roomId);\n                if (roomJoinUsReq) {\n                    //如果存在房间招人匹配,则同步删除匹配!\n                    this.removeMatchRequestAndResult(roomJoinUsReq);\n                }\n                break;\n            case ERoomRegChangedType.PlayerJoinRoom:\n                if (roomJoinUsReq) {\n                    //如果存在房间招人匹配,更新人数\n                    let fromInfo = roomJoinUsReq.matchFromInfo as IMatchFromRoomJoinUsOnServer;\n                    teamPlayerIdsAddSingle(fromInfo.teamsPlayerIds,\n                        regRoomChanged.joinRoomPlayerId, regRoomChanged.teamId);\n                    fromInfo.currPlayerCount = arrSum(fromInfo.teamsPlayerIds, t => t.playerIds.length);\n                }\n                break;\n            case ERoomRegChangedType.PlayerLeaveRoom:\n                if (roomJoinUsReq) {\n                    //如果存在房间招人匹配,更新人数\n                    let fromInfo = roomJoinUsReq.matchFromInfo as IMatchFromRoomJoinUsOnServer;\n                    teamPlayerIdsSubtractSingle(fromInfo.teamsPlayerIds,\n                        regRoomChanged.leaveRoomPlayerId, regRoomChanged.teamId);\n                    fromInfo.currPlayerCount = arrSum(fromInfo.teamsPlayerIds, t => t.playerIds.length);\n                }\n                break;\n            case ERoomRegChangedType.PlayerChangeTeam:\n                if (roomJoinUsReq) {\n                    //如果存在房间招人匹配,更新人数\n                    let fromInfo = roomJoinUsReq.matchFromInfo as IMatchFromRoomJoinUsOnServer;\n                    teamPlayerIdsSubtractSingle(fromInfo.teamsPlayerIds,\n                        regRoomChanged.changePlayerId, regRoomChanged.oldTeamId);\n                    teamPlayerIdsAddSingle(fromInfo.teamsPlayerIds,\n                        regRoomChanged.changePlayerId, regRoomChanged.newTeamId);\n                    fromInfo.currPlayerCount = arrSum(fromInfo.teamsPlayerIds, t => t.playerIds.length);\n                }\n                break;\n        }\n    }\n\n\n    /**停止定时轮询请求*/\n    protected stopPollReqs() {\n        if (this.pollMatchReqHd) clearTimeout(this.pollMatchReqHd);\n        this.pollMatchReqHd = null;\n    }\n    /**开始轮询所有请求*/\n    protected startPollAllReqs() {\n        this.stopPollReqs();\n        this.pollMatchReqHd = setTimeout(async () => await this.pollAllReqs(), 1000);\n    }\n    /**执行轮询所有请求（给匹配器执行自己匹配器下的请求集合）*/\n    protected async pollAllReqs(): Promise<void> {\n        //处理一遍超时的\n        await this.pollProcTimeoutReqs();\n\n        if (this.allMatcherReqs.size > 0) {\n            for (let [matcherKey, matcherReqs] of this.allMatcherReqs) {\n                let matcher = this.matchers.get(matcherKey);\n                if (!matcher || matcherReqs.length <= 0) continue;\n                logger.log('AppMatchRequestMgr', `pollAllReqs: ${matcher.matcherKey},matcherReqsCount:${matcherReqs.length}`);\n                let result = matcher.onPollMatcherReqs(matcherReqs.slice());\n                await this.procMatcherExecResult(result, matcherReqs);\n            }\n        }\n        //重新开始定时轮询\n        this.startPollAllReqs();\n    }\n\n    /**新匹配请求添加进本管理器*/\n    protected async addNewMatchReq(matchReq: IMatchRequest): Promise<MatcherRequests> {\n        //更新请求相关字段\n        matchReq.startMatchTime = Date.now();\n        //添加到所有请求集合中\n        this.allReqs.set(matchReq.matchReqId, matchReq);\n        //添加到同匹配器下的请求集合中\n        let matcherAllReqs = this.allMatcherReqs.get(matchReq.matcherKey);\n        if (!matcherAllReqs) {\n            matcherAllReqs = new MatcherRequests(matchReq.matcherKey);\n            this.allMatcherReqs.set(matcherAllReqs.matcherKey, matcherAllReqs);\n        }\n        matcherAllReqs.push(matchReq);\n\n        if (matchReq.matchFromType === EMatchFromType.RoomJoinUs) {\n            //如果是房间招人匹配,特殊处理一下\n            let existsJoinUsReq = this.roomJoinUsReq.get(matchReq.matchFromInfo.roomId);\n            if (existsJoinUsReq) {\n                //居然存在同房间还有其他的招人匹配!正常不应该,但出现了就设置为失败\n                await this.faildMatchRequest(existsJoinUsReq, `被其他房间招人匹配覆盖！`, ErrorCodes.MatchRequestCancelled, matcherAllReqs);\n            }\n            //放在房间招人字典里,统一管理\n            this.roomJoinUsReq.set(matchReq.matchFromInfo.roomId, matchReq);\n        }\n\n        return matcherAllReqs;\n    }\n\n    protected stopPollProcTimeoutReqs() {\n        if (this.pollProcTimeoutMatchReqHd) clearTimeout(this.pollProcTimeoutMatchReqHd);\n        this.pollProcTimeoutMatchReqHd = null;\n    }\n    protected startPollProcTimeoutReqs() {\n        this.stopPollProcTimeoutReqs();\n        this.pollProcTimeoutMatchReqHd = setTimeout(async () => await this.pollProcTimeoutReqs(), 1000);\n    }\n    /**处理超时的匹配(设置结果并移出管理)*/\n    protected async pollProcTimeoutReqs(): Promise<void> {\n        if (this.allMatcherReqs.size > 0) {\n            let now = Date.now();\n            let timeoutReqIds: IMatchRequest[] = [];\n            for (let matcherKey of this.allMatcherReqs.keys()) {\n                let matcherReqs = this.allMatcherReqs.get(matcherKey);\n                let matcher = this.matchers.get(matcherKey);\n                if (!matcher || !matcherReqs || matcherReqs.length <= 0) continue;\n                for (let i = 0; i < matcherReqs.length; i++) {\n                    let req = matcherReqs[i];\n                    if (!req.matchTimeoutSec) continue;\n                    if (req.startMatchTime + req.matchTimeoutSec * 1000 < now) {\n                        //这个请求已经超时\n                        timeoutReqIds.push(req);\n                    }\n                }\n            }\n            if (timeoutReqIds.length > 0) {\n                await this.faildMatchRequests(timeoutReqIds, '匹配超时！', ErrorCodes.MatchTimeout);\n            }\n        }\n\n        //重新开始定时轮询\n        this.startPollProcTimeoutReqs();\n    }\n\n    /**当收到新匹配请求的处理*/\n    protected async onNewAppMatchProc(matchProc: IMatchProc) {\n        if (matchProc.procType === EMatchProcType.RequestMatch) {\n            //收到新的匹配请求\n            return await this.onNewAppMatchReq(matchProc.matchReqId);\n        } else if (matchProc.procType === EMatchProcType.CancelMatch) {\n            //收到取消匹配操作\n            return await this.onCancelMatchReq(matchProc.matchReqId);\n        }\n    }\n    protected async onNewAppMatchReq(matchReqId: string) {\n        let matchReq = await this.reqHelper.getMatchRequest(this.appId, matchReqId);\n        if (!matchReq) {\n            //全局请求数据已经被删除,则忽略\n            logger.warn('AppMatchRequestMgr', '匹配请求已经被删除!', this.appId, matchReqId);\n            return;\n        }\n        let matcher = this.matchers.get(matchReq.matcherKey);\n        if (!matcher) {\n            //没实现的匹配器,设置匹配失败结果\n            return await this.faildMatchRequest(matchReq, `没有对应的匹配器实现${matchReq.matcherKey}`, ErrorCodes.MatchMatcherNotFound);\n        }\n        if (matchReq.matchFromType === EMatchFromType.RoomJoinUs) {\n            //如果是房间招人匹配, 则需要提交房间id\n            if (!matchReq.matchFromInfo.roomId) {\n                return await this.faildMatchRequest(matchReq, `matchFromInfo.roomId不能为空！`, ErrorCodes.ParamsError);\n            }\n        }\n\n        //验证都通过了,加入匹配请求!\n        let matcherAllReqs = await this.addNewMatchReq(matchReq);\n\n        //停止定时轮询\n        this.stopPollReqs();\n\n        //匹配器执行得到结果\n        logger.log('AppMatchRequestMgr', `onNewMatchReq:${matcher.matcherKey},matcherReqsCount:${matcherAllReqs.length}`);\n        let ret = matcher.onNewMatchReq(matchReq, matcherAllReqs.slice());\n        await this.procMatcherExecResult(ret, matcherAllReqs, matchReq);\n\n        //重新开始定时轮询\n        this.startPollAllReqs();\n\n    }\n    protected async onCancelMatchReq(matchReqId: string) {\n        let matchReq: IMatchRequest | undefined | null = this.allReqs.get(matchReqId);\n        if (!matchReq) {\n            //如果不在本地，则尝试读取redis中的\n            matchReq = await this.reqHelper.getMatchRequest(this.appId, matchReqId);\n            if (!matchReq) {\n                //还是没有，则忽略掉，当作已经完成取消！\n                return;\n            }\n        }\n        let matcherReqs = this.allMatcherReqs.get(matchReq.matcherKey);\n        if (!matcherReqs) {\n            matcherReqs = new MatcherRequests(matchReq.matcherKey);\n            this.allMatcherReqs.set(matcherReqs.matcherKey, matcherReqs);\n        }\n\n        let result = Result.buildErr<IMatchResult>('请求被取消', ErrorCodes.MatchRequestCancelled);\n        this.setMatchRequestResult(matchReq, result, matcherReqs);\n    }\n\n\n\n    /**\n     * 处理匹配器执行结果\n     *\n     * @protected\n     * @param result\n     * @param matcherAllReqs 匹配器下的所有匹配请求, 只有在新的匹配请求且没对应匹配器时，才没得传！\n     * @param currReq 针对单个匹配请求触发时\n     * @returns\n     */\n    protected async procMatcherExecResult(result: IMatcherExecResult, matcherAllReqs?: MatcherRequests, currReq?: IMatchRequest): Promise<void> {\n        if (result.resultErrCode || result.resultErrMsg) {\n            result.resultErrMsg = result.resultErrMsg ?? '匹配失败';\n            result.resultErrCode = result.resultErrCode ?? ErrorCodes.MatchUnknown;\n            //有错误，并且有指定请求，才设置当前请求为失败\n            if (currReq) {\n                this.faildMatchRequest(currReq, result.resultErrMsg, result.resultErrCode);\n                return;\n            }\n            if (matcherAllReqs) {\n                for (let req of matcherAllReqs) {\n                    this.faildMatchRequest(req, result.resultErrMsg, result.resultErrCode);\n                }\n                return;\n            }\n            return;\n        }\n        if (!result.hasResult) {\n            //没结果直接返回\n            return;\n        }\n\n        if (!matcherAllReqs) {\n            //正常这里要传当前匹配器下的所有请求,如果没有\n            logger.error(`AppMatchRequestMgr.procMatcherExecResult 都有结果了，还没传匹配器下所有匹配请求！`);\n            return;\n        }\n\n        if (result.resultCreateRoom) {\n            //匹配结果有创建房间\n            for (let createRoomResult of result.resultCreateRoom) {\n                if (createRoomResult.matchRequestPlayerResults.length <= 0) continue;\n                let createRoomRet = await this.gameClusterTerminal.createRoom(\n                    this.appId, createRoomResult.createRoomPara, ERoomCreateType.MATCH_CREATE);\n                if (!createRoomRet.succ) {\n                    createRoomResult.matchRequestPlayerResults.forEach(async reqPlayerResult => {\n                        let req = matcherAllReqs.find(r => r.matchReqId === reqPlayerResult.matchReqId);\n                        if (!req) return;\n                        await this.faildMatchRequest(req, createRoomRet.err!, createRoomRet.code);\n                    });\n                    return;\n                }\n\n                let roomOnlineInfo = createRoomRet.data;\n\n                let matchTeamsPlayerIds: ITeamPlayerIds[] = [];\n                let firstReq!: IMatchRequest;\n                //分派请求结果, 同时匹配结果的玩家信息转成队伍玩家的结构\n                for (let reqPlayerResult of createRoomResult.matchRequestPlayerResults) {\n                    let req = matcherAllReqs.find(r => r.matchReqId === reqPlayerResult.matchReqId);\n                    if (!req) continue;\n                    if (!firstReq) firstReq = req;\n\n                    for (let playerRet of reqPlayerResult.matchPlayerResults) {\n                        teamPlayerIdsAddSingle(matchTeamsPlayerIds, playerRet.playerId, playerRet.teamId);\n                    }\n                    let matchResult: IMatchResult = {\n                        roomId: roomOnlineInfo.roomId,\n                        gameServerUrl: roomOnlineInfo.gameServerUrl,\n                        matchPlayerResults: reqPlayerResult.matchPlayerResults,\n                    };\n                    await this.succMatchRequest(req, matchResult, matcherAllReqs);\n                }\n\n                if (createRoomResult.roomJoinUsMatch) {\n                    //创建好的房间,如果还需要继续招人匹配\n                    //则构建匹配请求数据,并加入本管理(将在下个轮询或者下个新匹配时触发)\n                    let useReq = firstReq;\n                    let roomJoinUsReq =\n                        buildRoomJoinUsMatchRequest(useReq, roomOnlineInfo.roomId, matchTeamsPlayerIds);\n                    await this.addNewMatchReq(roomJoinUsReq);\n                }\n            }\n        }\n\n        if (result.resultJoinRoom) {\n            //匹配结果有加入房间\n            for (let joinRoomResult of result.resultJoinRoom) {\n                //找到要加入的房间的注册信息\n                let getRoomOLInfo = await this.gameClusterTerminal.getRoomOnlineInfo(joinRoomResult.joinRoomId);\n                if (!getRoomOLInfo.succ) {\n                    joinRoomResult.matchRequestPlayerResults.forEach(async reqPlayerResult => {\n                        let req = matcherAllReqs.find(r => r.matchReqId === reqPlayerResult.matchReqId);\n                        if (!req) return;\n                        //房间已经被解散, 但因为对玩家来说是加入一个现有房间, 所以还是返回服务器爆满\n                        await this.faildMatchRequest(req, getRoomOLInfo.err!, getRoomOLInfo.code);\n                    });\n                    return;\n                }\n                //要追加到房间的队伍玩家列表\n                let matchTeamsPlayerIds: ITeamPlayerIds[] = [];\n\n                //分派请求结果, 同时匹配结果的玩家信息转成队伍玩家的结构\n                for (let reqPlayerResult of joinRoomResult.matchRequestPlayerResults) {\n                    let req = matcherAllReqs.find(r => r.matchReqId === reqPlayerResult.matchReqId);\n                    if (!req) continue;\n                    for (let playerRet of reqPlayerResult.matchPlayerResults) {\n                        teamPlayerIdsAddSingle(matchTeamsPlayerIds, playerRet.playerId, playerRet.teamId);\n                    }\n                    let matchResult: IMatchResult = {\n                        roomId: joinRoomResult.joinRoomId,\n                        gameServerUrl: getRoomOLInfo.data.gameServerUrl,\n                        matchPlayerResults: reqPlayerResult.matchPlayerResults,\n                    };\n                    await this.succMatchRequest(req, matchResult, matcherAllReqs);\n                }\n\n                let roomJoinUsMatch = this.roomJoinUsReq.get(joinRoomResult.joinRoomId);\n                if (roomJoinUsMatch) {\n                    //这个房间存在招人匹配,则需要额外处理\n                    let fromInfo = roomJoinUsMatch.matchFromInfo as IMatchFromRoomJoinUsOnServer;\n                    //将结果中增加的匹配玩家,追加到这个房间的队伍玩家数据中\n                    teamPlayerIdsAdd(fromInfo.teamsPlayerIds, matchTeamsPlayerIds);\n                    if (!joinRoomResult.roomJoinUsMatch) {\n                        //加入的房间,要求停止招人匹配,执行清除数据\n                        this.removeMatchRequestAndResult(roomJoinUsMatch);\n                    }\n                }\n            }\n        }\n\n    }\n\n    /**\n     * 设置匹配请求结果,并移除本地数据\n     *\n     * @protected\n     * @param matchReq\n     * @param result\n     * @param matcherAllReqs 如果有获取好的匹配器所有请求,则传入\n     * @returns\n     */\n    protected async setMatchRequestResult(matchReq: IMatchRequest, result: IResult<IMatchResult>, matcherAllReqs?: IMatchRequest[]): Promise<boolean> {\n        if (!matcherAllReqs) {\n            matcherAllReqs = this.allMatcherReqs.get(matchReq.matcherKey);\n        }\n        if (matcherAllReqs) {\n            //匹配器请求中移除\n            arrRemoveItems(matcherAllReqs, r => r.matchReqId === matchReq.matchReqId);\n        }\n        //从所有请求中移除\n        this.allReqs.delete(matchReq.matchReqId);\n        //如果是房间招人的匹配,则同步删除房间招人匹配列表\n        if (matchReq.matchFromType === EMatchFromType.RoomJoinUs) {\n            this.roomJoinUsReq.delete(matchReq.matchFromInfo.roomId);\n        }\n        //设置redis中的匹配结果\n        return await this.reqHelper.setMatchRequestResult(this.appId, matchReq, result);\n    }\n\n    /**\n     * 移除匹配请求数据(本地和redis), 只有在不需要结果的情况下,才直接删除(比如已经拿到结果 或者 系统类型取消如房间招人匹配)\n     *\n     * @protected\n     * @param matchReq\n     * @param matcherAllReqs 如果有获取好的匹配器所有请求,则传入\n     * @returns\n     */\n    protected async removeMatchRequestAndResult(matchReq: IMatchRequest, matcherAllReqs?: IMatchRequest[]): Promise<void> {\n        if (!matcherAllReqs) {\n            matcherAllReqs = this.allMatcherReqs.get(matchReq.matcherKey);\n        }\n        if (matcherAllReqs) {\n            //匹配器请求中移除\n            arrRemoveItems(matcherAllReqs, r => r.matchReqId === matchReq.matchReqId);\n        }\n        //从所有请求中移除\n        this.allReqs.delete(matchReq.matchReqId);\n        //如果是房间招人的匹配,则同步删除房间招人匹配列表\n        if (matchReq.matchFromType === EMatchFromType.RoomJoinUs) {\n            this.roomJoinUsReq.delete(matchReq.matchFromInfo.roomId);\n        }\n        //删除redis中的数据\n        return await this.reqHelper.removeMatchRequestAndResult(this.appId, matchReq.matchReqId);\n    }\n\n    /**\n     * 设置匹配请求为失败\n     *\n     * @public\n     * @param matchReq\n     * @param errMsg\n     * @param errCode 错误码请看 IMatcherExecResult 的注释\n     * @param matcherAllReqs 如果有获取好的匹配器所有请求,则传入\n     * @returns\n     */\n    public async faildMatchRequest(matchReq: IMatchRequest, errMsg: string, errCode: number, matcherAllReqs?: IMatchRequest[]): Promise<void> {\n        await this.setMatchRequestResult(matchReq, Result.buildErr(errMsg, errCode), matcherAllReqs);\n    }\n    /**\n     * 设置多个匹配请求为失败\n     *\n     * @public\n     * @param matcherReqs\n     * @param errMsg\n     * @param errCode 错误码请看 IMatcherExecResult 的注释\n     * @param matcherAllReqs 如果有获取好的匹配器所有请求,则传入\n     * @returns\n     */\n    public async faildMatchRequests(matcherReqs: Array<IMatchRequest>, errMsg: string, errCode: number, matcherAllReqs?: IMatchRequest[]): Promise<void> {\n        for (let req of matcherReqs) {\n            await this.setMatchRequestResult(req, Result.buildErr(errMsg, errCode), matcherAllReqs);\n        }\n    }\n    /**\n     * 设置匹配请求为成功\n     *\n     * @public\n     * @param matchReq\n     * @param result\n     * @param matcherAllReqs 如果有获取好的匹配器所有请求,则传入\n     * @returns\n     */\n    public async succMatchRequest(matchReq: IMatchRequest, result: IMatchResult, matcherAllReqs?: IMatchRequest[]): Promise<void> {\n        await this.setMatchRequestResult(matchReq, Result.buildSucc(result), matcherAllReqs);\n    }\n    /**\n     * 设置多个匹配请求为成功\n     *\n     * @public\n     * @param matcherReqs\n     * @param result\n     * @param matcherAllReqs 如果有获取好的匹配器所有请求,则传入\n     * @returns\n     */\n    public async succMatchRequests(matcherReqs: Array<IMatchRequest>, result: IMatchResult, matcherAllReqs?: IMatchRequest[]): Promise<void> {\n        for (let req of matcherReqs) {\n            await this.setMatchRequestResult(req, Result.buildSucc(result), matcherAllReqs);\n        }\n    }\n}"]}