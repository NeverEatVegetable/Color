{"version":3,"sources":["file:///E:/CocosProjects/Color/assets/ts-gameframework-master/servers/src/gameServer/api/ApiSendRoomMsg.ts"],"names":["ApiSendRoomMsg","call","gameServer","getGameServer","roomInfo","roomMgr","getRoomInfo","conn","currPlayer","error","fromPlayerInfo","req","robotPlayerId","roomRobotPlayers","get","playerInfo","playerInfos","roomMsg","recvType","ROOM_ALL","playerList","ROOM_OTHERS","filter","p","playerId","ROOM_SOME","recvPlayerList","length","pidList","includes","connList","gameConnMgr","getPlayerConn","push","server","broadcastMsg","recvRoomMsg","msg","succ","ERoomMsgRecvType"],"mappings":";;;;;AAKO,iBAAeA,cAAf,CAA8BC,IAA9B,EAAiF;AACpF,QAAIC,UAAU,GAAGD,IAAI,CAACE,aAAL,EAAjB;AACA,QAAIC,QAAQ,GAAG,MAAMF,UAAU,CAACG,OAAX,CAAmBC,WAAnB,CAA+BL,IAAI,CAACM,IAAL,CAAUC,UAAzC,CAArB;AACA,QAAI,CAACJ,QAAL,EAAe,OAAO,MAAMH,IAAI,CAACQ,KAAL,CAAW,UAAX,CAAb;AACf,QAAIC,cAAJ;;AACA,QAAIT,IAAI,CAACU,GAAL,CAASC,aAAb,EAA4B;AACxBF,MAAAA,cAAc,GAAGT,IAAI,CAACM,IAAL,CAAUC,UAAV,CAAqBK,gBAArB,CAAsCC,GAAtC,CAA0Cb,IAAI,CAACU,GAAL,CAASC,aAAnD,CAAjB;;AACA,UAAI,CAACF,cAAL,EAAqB;AACjB,eAAO,MAAMT,IAAI,CAACQ,KAAL,CAAW,QAAX,CAAb;AACH;AACJ,KALD,MAKO;AACHC,MAAAA,cAAc,GAAGT,IAAI,CAACM,IAAL,CAAUC,UAAV,CAAqBO,UAAtC;AACH;;AACD,QAAIC,WAAJ;AACA,QAAIC,OAAO,GAAGhB,IAAI,CAACU,GAAL,CAASM,OAAvB;;AACA,YAAQA,OAAO,CAACC,QAAhB;AACI,WAAK;AAAA;AAAA,gDAAiBC,QAAtB;AACIH,QAAAA,WAAW,GAAGZ,QAAQ,CAACgB,UAAvB;AACA;;AACJ,WAAK;AAAA;AAAA,gDAAiBC,WAAtB;AACIL,QAAAA,WAAW,GAAGZ,QAAQ,CAACgB,UAAT,CAAoBE,MAApB,CAA2BC,CAAC,IAAIA,CAAC,CAACC,QAAF,KAAed,cAAc,CAAEc,QAA/D,CAAd;AACA;;AACJ,WAAK;AAAA;AAAA,gDAAiBC,SAAtB;AACI,YAAI,CAACR,OAAO,CAACS,cAAT,IAA2BT,OAAO,CAACS,cAAR,CAAuBC,MAAvB,IAAiC,CAAhE,EAAmE;AAC/D,iBAAO,MAAM1B,IAAI,CAACQ,KAAL,CAAW,8BAAX,CAAb;AACH;;AACD,YAAImB,OAAiB,GAAGX,OAAO,CAACS,cAAhC;AACAV,QAAAA,WAAW,GAAGZ,QAAQ,CAAEgB,UAAV,CAAqBE,MAArB,CAA4BC,CAAC,IAAIK,OAAO,CAACC,QAAR,CAAiBN,CAAC,CAACC,QAAnB,CAAjC,CAAd;AACA;AAbR;;AAeA,QAAIR,WAAW,CAACW,MAAZ,GAAqB,CAAzB,EAA4B;AACxB,UAAIG,QAA4B,GAAG,EAAnC;;AACA,WAAK,IAAIf,UAAT,IAAuBC,WAAvB,EAAoC;AAChC,YAAIT,IAAI,GAAGL,UAAU,CAAC6B,WAAX,CAAuBC,aAAvB,CAAqCjB,UAAU,CAACS,QAAhD,CAAX;AACA,YAAI,CAACjB,IAAL,EAAW;AACXuB,QAAAA,QAAQ,CAACG,IAAT,CAAc1B,IAAd;AACH;;AACDL,MAAAA,UAAU,CAACgC,MAAX,CAAkBC,YAAlB,CAA+B,eAA/B,EAAgD;AAC5CC,QAAAA,WAAW,EAAE;AACTC,UAAAA,GAAG,EAAEpB,OAAO,CAACoB,GADJ;AAETnB,UAAAA,QAAQ,EAAED,OAAO,CAACC,QAFT;AAGTR,UAAAA,cAAc,EAAEA;AAHP;AAD+B,OAAhD,EAMGoB,QANH;AAOH;;AACD,WAAO,MAAM7B,IAAI,CAACqC,IAAL,CAAU,EAAV,CAAb;AACH;;;;;;;;;;;;;;;;;;;;;;;;;;4BA9CqBtC,c;;;;;;;;AAJbuC,MAAAA,gB,iBAAAA,gB","sourcesContent":["import { IPlayerInfo } from \"../../shared/tsgf/player/IPlayerInfo\";\nimport { ERoomMsgRecvType } from \"../../shared/tsgf/room/IRoomMsg\";\nimport { ReqSendRoomMsg, ResSendRoomMsg } from \"../../shared/gameClient/protocols/PtlSendRoomMsg\";\nimport { ClientConnection, GameApiCall } from \"../GameServer\";\n\nexport async function ApiSendRoomMsg(call: GameApiCall<ReqSendRoomMsg, ResSendRoomMsg>) {\n    let gameServer = call.getGameServer();\n    let roomInfo = await gameServer.roomMgr.getRoomInfo(call.conn.currPlayer);\n    if (!roomInfo) return await call.error('玩家不在房间中！');\n    let fromPlayerInfo: IPlayerInfo | undefined;\n    if (call.req.robotPlayerId) {\n        fromPlayerInfo = call.conn.currPlayer.roomRobotPlayers.get(call.req.robotPlayerId);\n        if (!fromPlayerInfo) {\n            return await call.error('非可控玩家!');\n        }\n    } else {\n        fromPlayerInfo = call.conn.currPlayer.playerInfo;\n    }\n    let playerInfos: IPlayerInfo[];\n    let roomMsg = call.req.roomMsg;\n    switch (roomMsg.recvType) {\n        case ERoomMsgRecvType.ROOM_ALL:\n            playerInfos = roomInfo.playerList;\n            break;\n        case ERoomMsgRecvType.ROOM_OTHERS:\n            playerInfos = roomInfo.playerList.filter(p => p.playerId !== fromPlayerInfo!.playerId);\n            break;\n        case ERoomMsgRecvType.ROOM_SOME:\n            if (!roomMsg.recvPlayerList || roomMsg.recvPlayerList.length <= 0) {\n                return await call.error('指定玩家接收，则需要定义recvPlayerList字段');\n            }\n            let pidList: string[] = roomMsg.recvPlayerList;\n            playerInfos = roomInfo!.playerList.filter(p => pidList.includes(p.playerId));\n            break;\n    }\n    if (playerInfos.length > 0) {\n        let connList: ClientConnection[] = [];\n        for (let playerInfo of playerInfos) {\n            let conn = gameServer.gameConnMgr.getPlayerConn(playerInfo.playerId);\n            if (!conn) continue;\n            connList.push(conn);\n        }\n        gameServer.server.broadcastMsg(\"NotifyRoomMsg\", {\n            recvRoomMsg: {\n                msg: roomMsg.msg,\n                recvType: roomMsg.recvType,\n                fromPlayerInfo: fromPlayerInfo,\n            }\n        }, connList);\n    }\n    return await call.succ({});\n}"]}