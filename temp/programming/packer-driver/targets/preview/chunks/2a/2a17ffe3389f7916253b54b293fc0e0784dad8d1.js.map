{"version":3,"sources":["file:///E:/CocosProjects/Color/assets/ts-gameframework-master/servers/src/serverConfigMgr.ts"],"names":["startWatchServerConfig","getAndInitConfig","cfg","getServerConfig","redisConfig","log","error","buildErr","buildSucc","ret","serverConfigPath","getConfig","succ","transition","data","memServerConfig","err","setMemServerConfig","getServerRedisClient","reuseClient","path","getConfigAuto","startWatchConfig","getRedisClient","initRedisClient","logger","parseProcessArgv","parseProcessEnv","Result","processArgs","process","argv","splice","processEnv","env","tsgfConfigFile","resolve","__dirname"],"mappings":";;;;;;;;;AAqBA;WACsBA,sB;;;AAwBtB;;;;gDAxBO,aAAyE;AAC5E,UAAIC,gBAAuD;AAAA,sCAAG,aAAY;AACtE,cAAIC,GAAG,SAASC,eAAe,EAA/B;;AACA,cAAID,GAAG,CAACE,WAAR,EAAqB;AACjB;AAAA;AAAA,kCAAOC,GAAP;AACA;AAAA;AAAA,oDAAgBH,GAAG,CAACE,WAApB;AACH,WAHD,MAGO;AACH;AAAA;AAAA,kCAAOE,KAAP;AACA,mBAAO;AAAA;AAAA,kCAAOC,QAAP,CAAgB,iBAAhB,CAAP;AACH;;AACD,iBAAO;AAAA;AAAA,gCAAOC,SAAP,CAAiBN,GAAjB,CAAP;AACH,SAV0D;;AAAA,wBAAvDD,gBAAuD;AAAA;AAAA;AAAA,SAA3D;;AAWA,UAAIQ,GAAG,SAAS;AAAA;AAAA,gDAAiBC,gBAAjB,EAAmC,MAAM;AACrD,YAAI,CAACC,SAAL,EAAgB;AAChB;AAAA;AAAA,8BAAON,GAAP,6EAA8BK,gBAA9B;AACAT,QAAAA,gBAAgB;AACnB,OAJe,CAAhB;;AAKA,UAAI,CAACQ,GAAG,CAACG,IAAT,EAAe;AACX,eAAO;AAAA;AAAA,8BAAOC,UAAP,CAAkBJ,GAAlB,CAAP;AACH;;AACD,UAAIE,SAAS,GAAGF,GAAG,CAACK,IAApB;AACA,mBAAab,gBAAgB,EAA7B;AACH,K;;;;WAGqBE,e;;;AAYtB;AACA;AACA;AACA;;;;yCAfO,aAAyD;AAC5D;AACA,UAAIY,eAAJ,EAAqB,OAAOA,eAAP,CAFuC,CAI5D;;AACA,UAAIN,GAAG,SAAS;AAAA;AAAA,0CAAcC,gBAAd,CAAhB;;AACA,UAAI,CAACD,GAAG,CAACG,IAAT,EAAe;AACX;AAAA;AAAA,8BAAON,KAAP,CAAaG,GAAG,CAACO,GAAjB;AACA,eAAO,EAAP;AACH;;AACD,aAAOP,GAAG,CAACK,IAAX;AACH,K;;;;AAKM,WAASG,kBAAT,CAA4Bf,GAA5B,EAA6D;AAChEa,IAAAA,eAAe,GAAGb,GAAlB;AACH;AACD;;;WACsBgB,oB;;;;;8CAAf,WAAoCC,WAApC,EAAwF;AAAA,UAApDA,WAAoD;AAApDA,QAAAA,WAAoD,GAA7B,IAA6B;AAAA;;AAC3F,mBAAa;AAAA;AAAA,4CAAeA,WAAf,CAAb;AACH,K;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;4BA/CqBnB,sB;qBAyBAG,e;wBAgBNc,kB;0BAIMC;;;;;;;;;AAnEfE,MAAAA,I;;AACEC,MAAAA,a,iBAAAA,a;AAAeC,MAAAA,gB,iBAAAA,gB;;AACfC,MAAAA,c,iBAAAA,c;AAAgBC,MAAAA,e,iBAAAA,e;;AAChBC,MAAAA,M,iBAAAA,M;;AACAC,MAAAA,gB,iBAAAA,gB;AAAkBC,MAAAA,e,iBAAAA,e;;AACTC,MAAAA,M,iBAAAA,M;;;;;;;AAIdC,MAAAA,W,GAAc;AAAA;AAAA,gDAAiBC,OAAO,CAACC,IAAR,CAAaC,MAAb,CAAoB,CAApB,CAAjB,C;AACdC,MAAAA,U,GAAa;AAAA;AAAA,8CAAgBH,OAAO,CAACI,GAAxB,C,EACjB;;AACIC,MAAAA,c,oCAAiBN,WAAW,CAAC,gBAAD,C,oCAAsBI,UAAU,CAAC,gBAAD,C,mBAAsB,4B;AAGlFvB,MAAAA,gB,GAAmB;AAAA;AAAA,wBAAK0B,OAAL,CAAaC,SAAb,EAAwBF,cAAxB,C;AACvB;;AACIpB,MAAAA,e,GAAwC,I;AAE5C;AAAA;AAAA,4BAAOV,GAAP,CAAW,mBAAX,EAA+BK,gBAA/B","sourcesContent":["import path from \"path\";\nimport { getConfigAuto, startWatchConfig } from \"./shared/tsgfServer/gfConfigMgr\";\nimport { getRedisClient, initRedisClient, IRedisClient } from \"./shared/tsgfServer/redisHelper\";\nimport { logger } from \"./shared/tsgf/logger\";\nimport { parseProcessArgv, parseProcessEnv } from \"./shared/tsgf/Utils\";\nimport { IResult, Result } from \"./shared/tsgf/Result\";\nimport { IServerConfig } from \"./ServerConfig\";\n\n\nlet processArgs = parseProcessArgv(process.argv.splice(2));\nlet processEnv = parseProcessEnv(process.env);\n// 命令行参数 > 环境变量 > 默认值\nlet tsgfConfigFile = processArgs['tsgfConfigFile'] ?? processEnv['tsgfConfigFile'] ?? '../tsgf.server.config.json';\n\n\nlet serverConfigPath = path.resolve(__dirname, tsgfConfigFile);\n/**使用内存指定的配置*/\nlet memServerConfig: IServerConfig | null = null;\n\nlogger.log('serverConfigPath:',serverConfigPath);\n\n/**开始监控gf.clusterServer.config.json配置, 并返回获取到的配置对象 */\nexport async function startWatchServerConfig(): Promise<IResult<IServerConfig>> {\n    let getAndInitConfig: () => Promise<IResult<IServerConfig>> = async () => {\n        let cfg = await getServerConfig();\n        if (cfg.redisConfig) {\n            logger.log(`初始化redis配置`);\n            initRedisClient(cfg.redisConfig);\n        } else {\n            logger.error(`redisConfig未配置!`);\n            return Result.buildErr(\"redisConfig未配置!\");\n        }\n        return Result.buildSucc(cfg);\n    };\n    let ret = await startWatchConfig(serverConfigPath, () => {\n        if (!getConfig) return;\n        logger.log(`配置文件更新,重新加载中...[${serverConfigPath}]`);\n        getAndInitConfig();\n    });\n    if (!ret.succ) {\n        return Result.transition(ret);\n    }\n    let getConfig = ret.data;\n    return await getAndInitConfig();\n}\n\n/**获取gf.clusterServer.config.json配置，配置文件有变化会自动读取最新的*/\nexport async function getServerConfig(): Promise<IServerConfig> {\n    //如果有指定内存配置，则直接返回\n    if (memServerConfig) return memServerConfig;\n\n    //尝试加载文件配置\n    let ret = await getConfigAuto(serverConfigPath);\n    if (!ret.succ) {\n        logger.error(ret.err);\n        return {} as any;\n    }\n    return ret.data as IServerConfig;\n}\n/**\n * 指定使用内存配置\n * @param cfg null表示清除内存配置，获取配置时会使用文件配置\n */\nexport function setMemServerConfig(cfg: IServerConfig | null): void {\n    memServerConfig = cfg;\n}\n/**获取gf.clusterServer.config.json配置中的redis客户端实例，配置文件有变化会自动使用最新的*/\nexport async function getServerRedisClient(reuseClient: boolean = true): Promise<IRedisClient> {\n    return await getRedisClient(reuseClient);\n}\n"]}