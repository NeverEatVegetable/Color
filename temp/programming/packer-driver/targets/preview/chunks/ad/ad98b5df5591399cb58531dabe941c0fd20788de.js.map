{"version":3,"sources":["file:///E:/CocosProjects/Color/assets/ts-gameframework-master/servers/test/loadTest/onlineTest.ts"],"names":["createWorkerState","isEnd","isReady","fsList","fsAverage","inputFsList","inputFsAverage","calculateInputFS","createPlayerJoin","openId","roomId","gameServerUrl","auth","buildErr","ret","playerToken","createRoomRet","count","isOk","createRet","playerId","maxPlayers","succ","err","data","workerRun","id","inputFS","postMessage","step","process","exit","gameClient","mockInputFS","frameBatchCount","framePrevTime","onStartFrameSync","Date","now","startInputFrame","test","rtInputFS","onRecvFrame","useTime","fs","onStopFrameSync","cancel","disconnect","endFn","Promise","res","d","runWorker","cb","workerData","worker","__filename","on","message","exitCode","frameData","outRTInputFS","expectInterval","Math","floor","prev","timerHandler","rtBatchCount","rtPrevTime","next","client","isConnected","playerInpFrame","rtFS","prevSendInvTime","nextInv","setTimeout","clearTimeout","runOnline","allPlayerCount","syncFrameSec","workerCount","allFsAverage","allInputFsAverage","allCalculateInputFSAverage","logger","log","waitAllReady","workerRet","Map","workers","get","set","console","push","size","args","tmpWorkers","values","allState","startFrameSync","stopFrameSync","allFsCount","allInputFsCount","allCalculateInputFSCount","length","sum","Worker","isMainThread","parentPort","assert","Result","delay","authPlayerToken","createAndEnterRoom","joinRoomUseGameServerResult","setLogEnabled","playerCount","frameSyncSec","then"],"mappings":"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","sourcesContent":["import { Worker, isMainThread, parentPort, workerData } from 'worker_threads';\nimport { assert } from \"chai\";\nimport { GameClient } from \"../../src/shared/gameClient/GameClient\";\nimport { IResult, Result } from \"../../src/shared/tsgf/Result\";\nimport { delay } from \"../../src/shared/tsgf/Utils\";\nimport { authPlayerToken, createAndEnterRoom, ICreateAndEnterResult, joinRoomUseGameServerResult, setLogEnabled } from \"../unitTest/api/ApiUtils\";\n\ninterface IWorkerData {\n    id: number;\n    roomId: string;\n    gameServerUrl: string;\n    inputFS: number;\n}\ninterface IWorkerState {\n    isEnd: boolean;\n    isReady: boolean;\n    fsList: number[];\n    fsAverage: number;\n    inputFsList: number[];\n    inputFsAverage: number;\n    calculateInputFS: number;\n}\nfunction createWorkerState(): IWorkerState {\n    return {\n        isEnd: false,\n        isReady: false,\n        fsList: [],\n        fsAverage: 0,\n        inputFsList: [],\n        inputFsAverage: 0,\n        calculateInputFS: 0,\n    };\n}\ninterface IMockInputFSHandler {\n    calculateInputFS: number;\n    cancel: () => void;\n}\ninterface ITestReportData {\n    allState: Map<number, IWorkerState>;\n    allFsAverage: number;\n    allInputFsAverage: number;\n    allCalculateInputFSAverage: number;\n}\n\nasync function createPlayerJoin(openId: string, roomId: string, gameServerUrl: string): Promise<IResult<GameClient>> {\n    let auth = await authPlayerToken(openId, openId);\n    if (!auth) return Result.buildErr(`auth失败：${openId}`);\n    let ret = await joinRoomUseGameServerResult(gameServerUrl, auth.playerToken, roomId, openId);\n\n    return ret;\n}\nasync function createRoomRet(openId: string, count: number): Promise<ICreateAndEnterResult> {\n    let auth = await authPlayerToken(openId, openId);\n    assert.isOk(auth, `auth失败：zum1`);\n    let createRet = await createAndEnterRoom(auth.playerToken, auth.playerId, 'zum1', {\n        maxPlayers: count,\n    });\n    assert.isOk(createRet.succ, createRet.err);\n    return createRet.data!;\n}\n\nasync function workerRun({ id, roomId, gameServerUrl, inputFS }: IWorkerData) {\n    let ret = await createPlayerJoin(`open${id}`, roomId, gameServerUrl);\n    if (!ret.succ) {\n        parentPort?.postMessage({ step: 'error', ret });\n        process.exit(0);\n    }\n    let gameClient = ret.data;\n    let mockInputFS: IMockInputFSHandler | null = null;\n    let frameBatchCount = 0;\n    let framePrevTime = 0;\n    gameClient.onStartFrameSync = () => {\n        framePrevTime = Date.now();\n        mockInputFS = startInputFrame(id, gameClient, inputFS, { test: '测试我是个输入帧' }, (rtInputFS) => {\n            parentPort?.postMessage({ step: 'rtInputFS', ret: { data: { rtInputFS } } });\n        });\n        parentPort?.postMessage({\n            step: 'startInputFrame', ret: {\n                data: {\n                    calculateInputFS: mockInputFS.calculateInputFS,\n                }\n            }\n        });\n    };\n    gameClient.onRecvFrame = () => {\n        frameBatchCount++;\n        if (frameBatchCount >= 10) {\n            let useTime = Date.now() - framePrevTime;\n            let fs = frameBatchCount / useTime * 1000;\n            parentPort?.postMessage({ step: 'frameState', ret: { data: { fs } } });\n            frameBatchCount = 0;\n            framePrevTime = Date.now();\n        }\n    };\n    gameClient.onStopFrameSync = async () => {\n        mockInputFS?.cancel();\n        await gameClient.disconnect();\n        endFn?.();\n        endFn = null;\n    };\n\n    let endFn: ((...args: any[]) => void) | null = null;\n    parentPort?.postMessage({ step: 'ready' });\n    await new Promise(res => {\n        endFn = (d) => res(d);\n    })\n}\n\nfunction runWorker(id: number, cb: (data: { id: number, step: string, ret?: any }) => void, workerData: IWorkerData) {\n    const worker = new Worker(__filename, { workerData });\n    worker.on('message', (d) => cb({ ...d, id, }));\n    worker.on('error', (err) => cb({ id, step: 'initError', ret: { err: err.message } }));\n    worker.on('exit', (exitCode) => {\n        if (exitCode === 0) {\n            return null;\n        }\n        cb({ id, step: 'exitError', ret: { id, err: `Worker has stopped with code ${exitCode}` } });\n    });\n    return worker;\n}\n\n/**\n * 开始模拟输入帧率额\n * @param gameClient \n * @param inputFS 计划的输入帧，因为是会换算成每多少毫秒发送一次，如果不能整除，将会替换为最接近的帧率来模拟\n * @param frameData 发送的帧数据\n * @param outRTInputFS 间隔通知外部实际输入帧率\n * @returns mock input frame \n */\nfunction startInputFrame(id: number, gameClient: GameClient, inputFS: number, frameData: any, outRTInputFS: (rtInputFS: number) => void): IMockInputFSHandler {\n    // 计算出期望间隔时间\n    let expectInterval = Math.floor(1000 / inputFS);\n    if (expectInterval < 4) expectInterval = 4;//定时任务实际最小间隔为4ms\n    // 再反算出这个间隔时间对应的输入帧率,叫做计算输入帧率\n    let calculateInputFS = Math.floor(1000 / expectInterval);\n    let prev = Date.now();\n    let timerHandler: any = null;\n    let rtBatchCount = 0;\n    let rtPrevTime = Date.now();\n    let next = async () => {\n        if (!timerHandler) return;\n        if (!gameClient.client || !gameClient.client.isConnected) return;\n        await gameClient.playerInpFrame([frameData]);\n        if (!timerHandler) return;//await回来，可能外部取消了，直接返回\n        rtBatchCount++;\n        if (rtBatchCount >= 10) {\n            //每10次发送，计算一次实际输入帧率   \n            let useTime = Date.now() - rtPrevTime;\n            let rtFS = rtBatchCount / useTime * 1000;\n            outRTInputFS(rtFS);//通知外部收集\n            rtPrevTime = Date.now();\n            rtBatchCount = 0;\n        }\n        //距离上次定时过去的时间,正常情况下应该超过interval，毕竟是间隔+发送数据的开销\n        let prevSendInvTime = Date.now() - prev;\n        //动态计算下次间隔\n        let nextInv = 2 * expectInterval - prevSendInvTime;\n        //实际耗时都超过想要的间隔了, 按最少4ms来计算\n        if (nextInv < 4) nextInv = 4;\n        prev = Date.now();\n        timerHandler = setTimeout(next, nextInv);\n        return timerHandler;\n    };\n    timerHandler = setTimeout(next, expectInterval);\n    return {\n        calculateInputFS,\n        cancel() {\n            clearTimeout(timerHandler);\n            timerHandler = null;\n        },\n    };\n}\n\n\nasync function runOnline(allPlayerCount: number, inputFS: number, syncFrameSec: number): Promise<ITestReportData> {\n    let workerCount = allPlayerCount - 1;\n    let roomId = '';\n    let gameServerUrl = '';\n\n    let allFsAverage = 0;\n    let allInputFsAverage = 0;\n    let allCalculateInputFSAverage = 0;\n\n    let ret = await createRoomRet('zum1', allPlayerCount);\n    roomId = ret.roomId;\n    gameServerUrl = ret.gameServerUrl;\n    let gameClient = ret.gameClient;\n    gameClient.client.logger!.log = () => { };//将普通日志都停掉，防止消息太多\n    let waitAllReady: ((...args: string[]) => void) | null = null;\n    let workerRet: Map<number, IWorkerState> = new Map();\n    let workers: Worker[] = [];\n    for (let id = 1; id <= workerCount; id++) {\n        let worker = runWorker(id, ({ id, step, ret }) => {\n            let d = workerRet.get(id);\n            if (!d) {\n                d = createWorkerState();\n                workerRet.set(id, d);\n            }\n            switch (step) {\n                case 'ready': {\n                    console.log(`id:${id} [${step}]`);\n                    d.isReady = true;\n                    break;\n                }\n                case 'startInputFrame': {\n                    d.calculateInputFS = ret.data.calculateInputFS;\n                    break;\n                }\n                case 'frameState': {\n                    d.fsList.push(ret.data.fs);\n                    break;\n                }\n                case 'rtInputFS': {\n                    d.inputFsList.push(ret.data.rtInputFS);\n                    break;\n                }\n                default: {\n                    console.log(`id:${id} [${step}]`, ret);\n                    d.isEnd = true;\n                    break;\n                }\n            }\n\n            if (workerRet.size === workerCount) {\n                waitAllReady?.();\n                waitAllReady = null;\n            }\n        }, { id, roomId, gameServerUrl, inputFS });\n        workers.push(worker);\n    }\n\n\n    await new Promise(res => {\n        waitAllReady = (args) => res(args)\n    });\n    let tmpWorkers = [...workerRet.values()];\n    if (tmpWorkers.count(d => d.isReady) !== workerCount) {\n        // 说明有问题，停止\n        console.log('线程等待时间完成');// 后续改成主线程通知完成才退出\n        await gameClient.disconnect();\n        return {\n            allState: workerRet,\n            allFsAverage,\n            allInputFsAverage,\n            allCalculateInputFSAverage,\n        };\n    }\n    // 如果都是准备的状态，则正常开始\n    console.log(`开始帧同步（运行${syncFrameSec}秒）`);\n    await gameClient.startFrameSync();\n\n    //在都准备好后，帧同步运行10秒\n    await delay(syncFrameSec * 1000);\n\n    await gameClient.stopFrameSync();\n    console.log('停止帧同步');\n\n    let allFsCount = 0;\n    let allInputFsCount = 0;\n    let allCalculateInputFSCount = 0;\n    for (let [id, d] of workerRet) {\n        if (d.fsList.length) {\n            d.fsAverage = d.fsList.sum() / d.fsList.length;\n            d.fsList.length = 0;\n            allFsAverage += d.fsAverage;\n            allFsCount++;\n        }\n        if (d.inputFsList.length) {\n            d.inputFsAverage = d.inputFsList.sum() / d.inputFsList.length;\n            d.inputFsList.length = 0;\n            allInputFsAverage += d.inputFsAverage;\n            allInputFsCount++;\n        }\n        if (d.calculateInputFS) {\n            allCalculateInputFSAverage += d.calculateInputFS;\n            allCalculateInputFSCount++;\n        }\n    }\n    if (allFsCount && allFsAverage) {\n        allFsAverage = allFsAverage / allFsCount;\n    }\n    if (allInputFsAverage && allInputFsCount) {\n        allInputFsAverage = allInputFsAverage / allInputFsCount;\n    }\n    if (allCalculateInputFSAverage && allCalculateInputFSCount) {\n        allCalculateInputFSAverage = allCalculateInputFSAverage / allCalculateInputFSCount;\n    }\n    return {\n        allState: workerRet,\n        allFsAverage,\n        allInputFsAverage,\n        allCalculateInputFSAverage,\n    };\n}\n\n\n//要把通讯的日志关掉，不然太多会出问题\nsetLogEnabled(false);\n\nlet playerCount = 50;//再大话，目前的机制，worker内部的通讯效率会变成瓶颈，除非数据在worker内部算好，结束后一次性推送\nlet inputFS = 10;\nlet frameSyncSec = 20;\n\nif (!isMainThread) {\n    workerRun(workerData);\n} else {\n    console.log(`开始运行${playerCount}人在线,${inputFS}输入帧率`);\n    runOnline(playerCount, inputFS, frameSyncSec).then(function (res) {\n        console.log(`结束运行`, res);\n        process.exit(0);\n    })\n}\n"]}