{"version":3,"sources":["file:///E:/CocosProjects/Color/assets/ts-gameframework-master/servers/src/gameServer/GameRoom.ts"],"names":["GameRoom","logger","EMatchFromType","ENetworkState","ErrorCodes","Result","EPlayerInputFrameType","EFrameSyncState","EPrivateRoomJoinMode","arrCount","arrGroup","arrRemoveItems","PlayerAuthHelper","ERoomRegChangedType","RoomHelper","buildPlayerRobotId","ConnectionCollection","FrameSyncGame","constructor","roomRegInfo","roomInfo","gameWsServer","gameConnMgr","matchReqTerminal","gameClusterClient","onlinePlayerConns","game","isDismiss","joinUsMatchReqId","onRoomAllPlayersMatchResult","onRoomAllPlayersMatchResultOther","c","playerId","connections","frameRate","randomRequirePlayerSyncStateInvMs","dispose","internalDismissRoom","triggerDismissRoomNotify","playerList","clearAllConnections","triggerPlayerJoinRoomNotify","joinPlayerInfo","broadcastMsg","joinPlayerId","filter","triggerPlayerLeaveRoomNotify","leavePlayerInfo","playerInfos","connList","playerInfo","playerConn","getPlayerConn","push","triggerStartFrameSyncNotify","startPlayerInfo","startPlayerId","triggerStopFrameSyncNotify","stopPlayerInfo","stopPlayerId","triggerChangePlayerNetworkState","changePlayerId","networkState","triggerChangeRoomNotify","triggerChangeCustomPlayerStatus","oldVal","customPlayerStatus","oldCustomPlayerStatus","triggerChangeCustomPlayerProfile","customPlayerProfile","oldCustomPlayerProfile","triggerChangePlayerTeam","teamId","oldTeamId","autoSetRoomJoinUsMatch","mustNew","isPrivate","matcherKey","maxPlayers","length","frameSyncState","START","disabledRoomJoinUsMatch","ret","requestMatch","appId","matchTimeoutSec","matchFromType","RoomJoinUs","matchFromInfo","roomId","currPlayerCount","teamsPlayerIds","slice","matcherParams","_","succ","error","err","data","cancelMatch","undefined","buildTeamsPlayerIds","arr","group","p","groupList","playerIds","map","dismissRoom","stopGame","tmpArr","roomPlayer","getPlayer","internalLeaveRoom","player","canUpdateRegInfo","authInfo","currRoomId","updatePlayerCurrRoomId","playerToken","leavePlayers","roomRobotPlayers","size","forEach","robitPlayer","internalLeaveRoomData","clear","emptySeats","getRoomEmptySeats","Promise","all","updateRoom","PlayerLeaveRoom","removeConnection","internalPlayerLeaveTeam","oldTeamIndex","teamList","findIndex","t","id","freeTeamMinPlayers","freeTeamMaxPlayers","splice","roomRobotIds","playerInpFrame","LeaveRoom","inpFrame","internalJoinRoom","joinPara","robotOwnPlayerInfo","existsPlayerInfo","find","buildSucc","buildErr","Exception","ownerPlayerId","retainOwnSeat","RoomPlayersFull","RoomForbidJoin","privateRoomJoinMode","forbidJoin","password","RoomMustPassword","privateRoomPassword","RoomPasswordWrong","changeTeamResult","internalChangePlayerTeam","code","Array","from","Set","addConnection","JoinRoom","PlayerJoinRoom","newTeamId","team","fixedTeamCount","RoomTeamNotFound","name","minPlayers","RoomTeamPlayersFull","PlayerChangeTeam","intenalChangeCustomPlayerStatus","newCustomPlayerStatus","intenalChangeCustomPlayerProfile","newCustomPlayerProfile","joinRoom","leaveRoom","leavePlayerInfos","retainEmptyRoomTime","RoomPermissionDenied","notifyPlayerInfos","changeRoom","changePara","changed","regChange","roomName","customProperties","ChangeInfo","changeCustomPlayerStatus","robotPlayerId","has","changeCustomPlayerProfile","changePlayerTeam","get","startGameFrameSync","startGameTime","Date","now","startGame","stopGameFrameSync","STOP","inpFrameType","setOthersProp","matchParams","allPlayerMatchReqId","MatchRequestCancelled","matchReq","matchResult","notifyTasks","playerResult","matchPlayerResults","conn","playerMatchResult","gameServerUrl","sendMsg","errMsg","errCode","call","reqRet","matchReqId","reqPlayerId","transition","queryMatch","queryTask","resolve","timeout","setTimeout","MatchQueryTimeout","clearTimeout","resultRet","queryRet","createRoomRobot","createPa","robotInfo","showName","isRobot","ONLINE","set","roomRobotLeave","tmpIds","delete"],"mappings":"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","sourcesContent":["\nimport { MsgPlayerInpFrame } from \"../shared/gameClient/protocols/MsgPlayerInpFrame\";\nimport { MatchRequestTerminal } from \"../shared/tsgfServer/match/MatchRequestTerminal\";\nimport { logger } from \"../shared/tsgf/logger\";\nimport { EMatchFromType, IMatchParamsFromPlayer, IMatchParamsFromRoomAllPlayer, IMatchResult, IMatchPlayerResultWithServer } from \"../shared/tsgf/match/Models\";\nimport { ENetworkState, IPlayerInfo, IPlayerInfoPara } from \"../shared/tsgf/player/IPlayerInfo\";\nimport { ErrorCodes, IResult, Result } from \"../shared/tsgf/Result\";\nimport { EPlayerInputFrameType, IFramePlayerInput } from \"../shared/tsgf/room/IGameFrame\";\nimport { EFrameSyncState, EPrivateRoomJoinMode, IChangeRoomPara, IJoinRoomPara, IRoomInfo, ITeamInfo, ITeamPlayerIds } from \"../shared/tsgf/room/IRoomInfo\";\nimport { arrCount, arrGroup, arrRemoveItems } from \"../shared/tsgf/Utils\";\nimport { IPlayer } from \"../shared/tsgfServer/auth/Models\";\nimport { PlayerAuthHelper } from \"../shared/tsgfServer/auth/PlayerAuthHelper\";\nimport { IMatchFromRoomAllPlayersOnServer, IMatchRequest } from \"../shared/tsgfServer/match/Models\";\nimport { IRoomRegInfo } from \"../shared/tsgfServer/room/Models\";\nimport { ERoomRegChangedType, RoomHelper } from \"../shared/tsgfServer/room/RoomHelper\";\nimport { buildGuid, buildPlayerId, buildPlayerRobotId } from \"../shared/tsgfServer/ServerUtils\";\nimport { ConnectionCollection } from \"./ConnectionCollection\";\nimport { FrameSyncGame } from \"./FrameSyncGame\";\nimport { GameConnMgr } from \"./GameConnMgr\";\nimport { ClientConnection, GameServer, GameWsServer } from \"./GameServer\";\nimport { GameClusterNodeClient } from \"../shared/tsgfServer/gameCluster/GameClusterNodeClient\";\n\n\n/**游戏房间操作对象*/\nexport class GameRoom {\n    private gameWsServer: GameWsServer;\n    private gameConnMgr: GameConnMgr;\n    private matchReqTerminal: MatchRequestTerminal;\n    private gameClusterClient: GameClusterNodeClient;\n    /**在线的玩家连接,连接标识使用的是玩家ID*/\n    public onlinePlayerConns: ConnectionCollection;\n    public roomRegInfo: IRoomRegInfo;\n    public roomInfo: IRoomInfo;\n    public game: FrameSyncGame;\n    public isDismiss: boolean = false;\n\n    /**招人匹配请求id,如果开启了则有值*/\n    private joinUsMatchReqId?: string;\n    /**内部设置当房间所有玩家发起匹配的结果回调*/\n    private onRoomAllPlayersMatchResult?: (matchResult: IResult<IMatchResult>) => any;\n    private onRoomAllPlayersMatchResultOther?: (matchResult: IResult<IMatchResult>) => any;\n\n    constructor(roomRegInfo: IRoomRegInfo, roomInfo: IRoomInfo,\n        gameWsServer: GameWsServer, gameConnMgr: GameConnMgr,\n        matchReqTerminal: MatchRequestTerminal,\n        gameClusterClient: GameClusterNodeClient\n    ) {\n        this.roomRegInfo = roomRegInfo;\n        this.roomInfo = roomInfo;\n        this.gameConnMgr = gameConnMgr;\n        this.gameWsServer = gameWsServer;\n        this.matchReqTerminal = matchReqTerminal;\n        this.gameClusterClient = gameClusterClient;\n        this.onlinePlayerConns = new ConnectionCollection(c => c.playerId);\n        this.game = new FrameSyncGame(this.roomInfo, gameWsServer, this.gameConnMgr,\n            () => this.onlinePlayerConns.connections, roomInfo.frameRate, roomInfo.randomRequirePlayerSyncStateInvMs);\n    }\n    public dispose() {\n\n        //如果还没解散就释放,则先执行解散\n        if (!this.isDismiss) {\n            //执行实际的解散逻辑（数据操作）\n            this.internalDismissRoom();\n            //触发事件\n            this.triggerDismissRoomNotify(this.roomInfo.playerList);\n        }\n\n        this.game.dispose();\n\n        this.onlinePlayerConns.clearAllConnections();\n    }\n\n    /**触发玩家进入房间事件的通知, 不会通知当前玩家*/\n    protected async triggerPlayerJoinRoomNotify(joinPlayerInfo: IPlayerInfo) {\n        await this.gameWsServer.broadcastMsg('NotifyJoinRoom', {\n            joinPlayerId: joinPlayerInfo.playerId,\n            roomInfo: this.roomInfo,\n        }, this.onlinePlayerConns.connections.filter(c => c.playerId !== joinPlayerInfo.playerId));\n    }\n    /**触发玩家离开房间事件的通知, 不会通知当前玩家*/\n    protected async triggerPlayerLeaveRoomNotify(leavePlayerInfo: IPlayerInfo) {\n        await this.gameWsServer.broadcastMsg('NotifyLeaveRoom', {\n            leavePlayerInfo: leavePlayerInfo,\n            roomInfo: this.roomInfo,\n        }, this.onlinePlayerConns.connections.filter(c => c.playerId !== leavePlayerInfo.playerId));\n    }\n    protected async triggerDismissRoomNotify(playerInfos: IPlayerInfo[]) {\n        let connList: ClientConnection[] = [];\n        for (let playerInfo of playerInfos) {\n            let playerConn = this.gameConnMgr.getPlayerConn(playerInfo.playerId);\n            if (!playerConn) continue;\n            connList.push(playerConn);\n        }\n        await this.gameWsServer.broadcastMsg('NotifyDismissRoom', {\n            roomInfo: this.roomInfo,\n        }, connList);\n    }\n    protected async triggerStartFrameSyncNotify(startPlayerInfo: IPlayerInfo) {\n        await this.gameWsServer.broadcastMsg('NotifyStartFrameSync', {\n            startPlayerId: startPlayerInfo.playerId,\n            roomInfo: this.roomInfo,\n        }, this.onlinePlayerConns.connections);\n    }\n    protected async triggerStopFrameSyncNotify(stopPlayerInfo: IPlayerInfo) {\n        await this.gameWsServer.broadcastMsg('NotifyStopFrameSync', {\n            stopPlayerId: stopPlayerInfo.playerId,\n            roomInfo: this.roomInfo,\n        }, this.onlinePlayerConns.connections);\n    }\n    public async triggerChangePlayerNetworkState(playerInfo: IPlayerInfo) {\n        await this.gameWsServer.broadcastMsg('NotifyChangePlayerNetworkState', {\n            roomInfo: this.roomInfo,\n            changePlayerId: playerInfo.playerId,\n            networkState: playerInfo.networkState,\n        }, this.onlinePlayerConns.connections);\n    }\n    protected async triggerChangeRoomNotify() {\n        await this.gameWsServer.broadcastMsg('NotifyChangeRoom', {\n            roomInfo: this.roomInfo,\n        }, this.onlinePlayerConns.connections);\n    }\n    public async triggerChangeCustomPlayerStatus(playerInfo: IPlayerInfo, oldVal: number) {\n        await this.gameWsServer.broadcastMsg('NotifyChangeCustomPlayerStatus', {\n            roomInfo: this.roomInfo,\n            changePlayerId: playerInfo.playerId,\n            customPlayerStatus: playerInfo.customPlayerStatus,\n            oldCustomPlayerStatus: oldVal,\n        }, this.onlinePlayerConns.connections);\n    }\n    public async triggerChangeCustomPlayerProfile(playerInfo: IPlayerInfo, oldVal: string) {\n        await this.gameWsServer.broadcastMsg('NotifyChangeCustomPlayerProfile', {\n            roomInfo: this.roomInfo,\n            changePlayerId: playerInfo.playerId,\n            customPlayerProfile: playerInfo.customPlayerProfile,\n            oldCustomPlayerProfile: oldVal,\n        }, this.onlinePlayerConns.connections);\n    }\n    public async triggerChangePlayerTeam(playerInfo: IPlayerInfo, oldVal?: string) {\n        await this.gameWsServer.broadcastMsg('NotifyChangePlayerTeam', {\n            roomInfo: this.roomInfo,\n            changePlayerId: playerInfo.playerId,\n            teamId: playerInfo.customPlayerProfile,\n            oldTeamId: oldVal,\n        }, this.onlinePlayerConns.connections);\n    }\n\n    /**自动设置(开启或停止)房间招人匹配*/\n    protected async autoSetRoomJoinUsMatch(mustNew = false): Promise<void> {\n\n        if (!this.roomInfo\n            || this.isDismiss\n            || this.roomInfo.isPrivate\n            || !this.roomInfo.matcherKey\n            || this.roomInfo.maxPlayers <= this.roomInfo.playerList.length\n            || this.roomInfo.frameSyncState === EFrameSyncState.START) {\n            //这里应该关闭匹配\n            this.disabledRoomJoinUsMatch();\n        } else {\n            //这里应该启用招人匹配\n            if (!mustNew && this.joinUsMatchReqId) {\n                //已经开启则忽略\n                return;\n            }\n            //请求匹配,并记录请求id\n            let ret = await this.matchReqTerminal.requestMatch(this.roomRegInfo.appId, {\n                matchTimeoutSec: 120, //最长2分钟轮询一次, 防止\n                matchFromType: EMatchFromType.RoomJoinUs,\n                matchFromInfo: {\n                    roomId: this.roomInfo.roomId,\n                    currPlayerCount: this.roomInfo.playerList.length,\n                    teamsPlayerIds: this.roomRegInfo.teamsPlayerIds.slice(),\n                },\n                matcherKey: this.roomInfo.matcherKey,\n                maxPlayers: this.roomInfo.maxPlayers,\n                matcherParams: {},\n            }, _ => {\n                //到这里应该是超时, 需要轮询状态, 防止中间有错误, 服务器内存就无限挂着一个无法连接的匹配房间!\n                this.autoSetRoomJoinUsMatch(true);\n            }, false);\n            if (!ret.succ) {\n                logger.error(`GameRoom.enabledRoomJoinUsMatch.requestMatch失败:${ret.err}  roomInfo:`, this.roomInfo);\n                return;\n            }\n            this.joinUsMatchReqId = ret.data;\n        }\n    }\n    /**停止房间招人匹配*/\n    protected async disabledRoomJoinUsMatch(): Promise<void> {\n        if (this.joinUsMatchReqId) {\n            await this.matchReqTerminal.cancelMatch(this.roomRegInfo.appId, this.joinUsMatchReqId);\n            this.joinUsMatchReqId = undefined;\n        }\n    }\n    /**生成队伍玩家id结构*/\n    protected buildTeamsPlayerIds(playerInfos: IPlayerInfo[]): ITeamPlayerIds[] {\n        let arr: ITeamPlayerIds[] = [];\n        let group = arrGroup(playerInfos, p => p.teamId);\n        for (let groupList of group) {\n            arr.push({\n                teamId: groupList[0] ?? '',\n                playerIds: groupList[1].map(p => p.playerId),\n            });\n        }\n        return arr;\n    }\n    /**\n     * [实际的数据操作] 解散房间\n     *\n     * @protected\n     * @returns\n     */\n    protected async internalDismissRoom(): Promise<void> {\n        if (this.isDismiss) return;\n\n        //删除房间注册信息, 截断后续新加入的人(存在失败的可能，集群可能先清理掉了，可以忽略)\n        await this.gameClusterClient.dismissRoom(this.roomInfo.roomId);\n\n        //停止游戏\n        this.game.stopGame();\n\n        //如果有开启招人匹配则停止\n        await this.disabledRoomJoinUsMatch();\n\n        //拷贝一份遍历,因为循环时会操作玩家数组\n        const tmpArr = [...this.roomInfo.playerList];\n        for (let playerInfo of tmpArr) {\n            let roomPlayer = this.gameConnMgr.getPlayer(playerInfo.playerId);\n            //机器人玩家没有连接, 忽略\n            if (!roomPlayer) continue;\n            await this.internalLeaveRoom(roomPlayer, false);\n        }\n        this.roomInfo.playerList.length = 0;\n        this.isDismiss = true;\n    }\n\n    /**\n     * [实际的数据操作] 玩家离开房间\n     *\n     * @public\n     * @param player\n     * @returns 返回实际离开的玩家数组(如果有会包含机器人玩家)\n     */\n    protected async internalLeaveRoom(player: IPlayer, canUpdateRegInfo: boolean = true): Promise<IPlayerInfo[]> {\n        let teamId = player.playerInfo.teamId;\n        //当前房间id设置为未定义\n        player.authInfo.currRoomId = undefined;\n        PlayerAuthHelper.updatePlayerCurrRoomId(player.authInfo.playerToken, player.authInfo.currRoomId);\n\n        const leavePlayers: IPlayerInfo[] = [];\n        if (player.roomRobotPlayers?.size) {\n            //玩家如果有连接机器人, 则先处理退出\n            player.roomRobotPlayers.forEach(robitPlayer => {\n                //自己的房间机器人操作离开房间数据\n                this.internalLeaveRoomData(robitPlayer);\n                leavePlayers.push(robitPlayer);\n            });\n            //清理房间机器人\n            player.roomRobotPlayers.clear();\n        }\n        //自己操作离开房间数据\n        this.internalLeaveRoomData(player.playerInfo);\n        leavePlayers.push(player.playerInfo);\n\n        //同步信息给房间注册信息\n        this.roomRegInfo.teamsPlayerIds = this.buildTeamsPlayerIds(this.roomInfo.playerList);\n        this.roomRegInfo.emptySeats = RoomHelper.getRoomEmptySeats(this.roomInfo);\n        if (canUpdateRegInfo) {\n            await Promise.all([\n                this.gameClusterClient.updateRoom(\n                    this.roomRegInfo,\n                    ERoomRegChangedType.PlayerLeaveRoom,\n                    player.playerInfo.playerId,\n                    teamId,\n                ),\n                //根据当前房间情况去自动开启或关闭招人匹配\n                this.autoSetRoomJoinUsMatch(),\n            ]);\n        }\n\n        //移除房间在线玩家连接\n        this.onlinePlayerConns.removeConnection(player.playerInfo.playerId);\n\n        return leavePlayers;\n    }\n\n    /**\n     * [内部实现] 玩家退出队伍的数据操作\n     * @param playerInfo \n     */\n    protected internalPlayerLeaveTeam(playerInfo: IPlayerInfo) {\n        let oldTeamId = playerInfo.teamId;\n        playerInfo.teamId = undefined;\n        if (oldTeamId) {\n            let oldTeamIndex = this.roomInfo.teamList.findIndex(t => t.id === oldTeamId);\n            if (oldTeamIndex > -1) {\n                //如果之前有在队伍中,需要处理\n                if (this.roomInfo.freeTeamMinPlayers && this.roomInfo.freeTeamMaxPlayers) {\n                    //是自由队伍的房间\n                    if (arrCount(this.roomInfo.playerList, p => p.teamId === oldTeamId) <= 0) {\n                        //之前队伍已经没人了,则销毁该队伍\n                        arrRemoveItems(this.roomInfo.teamList, t => t.id === oldTeamId);\n                        this.roomInfo.teamList.splice(oldTeamIndex, 1);\n                    }\n                }\n            }\n        }\n    }\n    /**玩家退出房间的数据操作*/\n    protected internalLeaveRoomData(playerInfo: IPlayerInfo) {\n        //玩家退出队伍数据操作\n        this.internalPlayerLeaveTeam(playerInfo);\n        //移除房间的玩家列表中该玩家对象\n        arrRemoveItems(this.roomInfo.playerList, p => p.playerId === playerInfo.playerId);\n        //离开房间了就清空当前房间控制的机器人列表(不管有没有)\n        playerInfo.roomRobotIds = undefined;\n        //玩家退出房间帧\n        this.game.playerInpFrame(playerInfo, EPlayerInputFrameType.LeaveRoom,\n            inpFrame => inpFrame.playerInfo = playerInfo);\n    }\n\n    /**玩家加入房间的内部操作, 同时会操作连接和通知, 成功的data===true则要求直接返回(如已经在房间中)*/\n    protected async internalJoinRoom(playerInfo: IPlayerInfo, joinPara: IJoinRoomPara, robotOwnPlayerInfo?: IPlayerInfo): Promise<IResult<boolean>> {\n        let existsPlayerInfo = this.roomInfo.playerList.find(p => p.playerId === playerInfo.playerId);\n        if (existsPlayerInfo) {\n            //这个玩家已经在房间中了，直接成功！\n            return Result.buildSucc(true);\n        }\n        let playerConn: ClientConnection | undefined;\n        if (!robotOwnPlayerInfo) {\n            //不是机器人,则需要处理连接\n            playerConn = this.gameConnMgr.getPlayerConn(playerInfo.playerId);\n            if (!playerConn) {\n                return Result.buildErr('玩家不在线！', ErrorCodes.Exception);\n            }\n        }\n        // 空位判断\n        if (this.roomRegInfo.emptySeats <= 0) {\n            // 但排除一种情况, 房主要进来由设置了保留空位, 则可以进!\n            if (playerInfo.playerId !== this.roomInfo.ownerPlayerId || !this.roomInfo.retainOwnSeat) {\n                //不是房主或者没设置给房主保留,则真满房~\n                return Result.buildErr('房间人数已满！', ErrorCodes.RoomPlayersFull);\n            }\n        }\n        if (this.roomInfo.isPrivate && this.roomInfo.ownerPlayerId !== playerInfo.playerId) {\n            // 私有房间,且加入的不是房主, 则需要验证一波\n            if (robotOwnPlayerInfo) {\n                //私有房的加机器人操作必须是房主\n                if (this.roomInfo.ownerPlayerId !== robotOwnPlayerInfo.playerId) {\n                    return Result.buildErr('房间不可加入！', ErrorCodes.RoomForbidJoin);\n                }\n            } else {\n                //正常玩家加入私有房的限制判断\n                switch (this.roomInfo.privateRoomJoinMode) {\n                    case EPrivateRoomJoinMode.forbidJoin:\n                        //房间不可加入时\n                        return Result.buildErr('房间不可加入！', ErrorCodes.RoomForbidJoin);\n                    case EPrivateRoomJoinMode.password:\n                        // 密码加入则需要提供密码\n                        if (!joinPara.password) {\n                            return Result.buildErr('房间需要密码！', ErrorCodes.RoomMustPassword);\n                        }\n                        if (joinPara.password !== this.roomRegInfo.privateRoomPassword) {\n                            return Result.buildErr('房间密码不正确！', ErrorCodes.RoomPasswordWrong);\n                        }\n                        break;\n                }\n            }\n        }\n        let changeTeamResult = await this.internalChangePlayerTeam(playerInfo, joinPara.teamId);\n        if (!changeTeamResult.succ) {\n            return Result.buildErr(changeTeamResult.err, changeTeamResult.code);\n        }\n        this.roomInfo.playerList.push(playerInfo);\n\n        if (robotOwnPlayerInfo) {\n            //是机器人, 则需要加到玩家拥有机器人数组上\n            robotOwnPlayerInfo.roomRobotIds = Array.from(new Set([\n                ...robotOwnPlayerInfo.roomRobotIds ?? [],\n                playerInfo.playerId\n            ]));\n        }\n\n        //加入房间先触发事件\n        await this.triggerPlayerJoinRoomNotify(playerInfo);\n\n        if (!robotOwnPlayerInfo) {\n            //不是机器人,则这个时候再把连接加入\n            this.onlinePlayerConns.addConnection(playerConn!);\n        }\n\n        //再给所有人发玩家加入房间的输入帧\n        this.game.playerInpFrame(playerInfo, EPlayerInputFrameType.JoinRoom,\n            inpFrame => inpFrame.playerInfo = playerInfo);\n\n        //更新房间注册信息\n        this.roomRegInfo.teamsPlayerIds = this.buildTeamsPlayerIds(this.roomInfo.playerList);\n        this.roomRegInfo.emptySeats = RoomHelper.getRoomEmptySeats(this.roomInfo);\n        await Promise.all([\n            this.gameClusterClient.updateRoom(\n                this.roomRegInfo,\n                ERoomRegChangedType.PlayerJoinRoom,\n                playerInfo.playerId,\n                joinPara.teamId,\n            ),\n            //根据当前房间情况去自动开启或关闭招人匹配\n            this.autoSetRoomJoinUsMatch(),\n        ]);\n\n        return Result.buildSucc(false);\n    }\n\n    /**内置变更玩家所在队伍, 只有实际变更了才会更新和推送, 有指定队伍会根据房间配置来初始化*/\n    protected async internalChangePlayerTeam(playerInfo: IPlayerInfo, newTeamId?: string): Promise<IResult<null>> {\n        if (newTeamId) {\n            //有指定队伍\n            let team = this.roomInfo.teamList.find(t => t.id === newTeamId);\n            if (!team) {\n                //不存在队伍需要判断情况\n                if (this.roomInfo.fixedTeamCount) {\n                    //又是固定队伍,所以直接返回失败!\n                    return Result.buildErr(`要加入的队伍id不存在[${newTeamId}]`, ErrorCodes.RoomTeamNotFound);\n                }\n                if (!this.roomInfo.freeTeamMinPlayers || !this.roomInfo.freeTeamMaxPlayers) {\n                    //但又没定义自由队伍的参数,所以直接返回失败!\n                    return Result.buildErr(`房间未定义自动创建队伍参数!`, ErrorCodes.RoomTeamNotFound);\n                }\n                team = {\n                    id: newTeamId,\n                    name: newTeamId,\n                    minPlayers: this.roomInfo.freeTeamMinPlayers,\n                    maxPlayers: this.roomInfo.freeTeamMaxPlayers,\n                };\n            }\n            if (arrCount(this.roomInfo.playerList, p => p.teamId === newTeamId) >= team.maxPlayers) {\n                return Result.buildErr(`要加入的队伍已满!`, ErrorCodes.RoomTeamPlayersFull);\n            }\n        }\n\n        let oldTeamId = playerInfo.teamId;\n        if (playerInfo.teamId !== newTeamId) {\n            //和之前队伍不一样才需要更新和推送\n            this.internalPlayerLeaveTeam(playerInfo);\n            playerInfo.teamId = newTeamId;\n            if (oldTeamId) {\n                let oldTeamIndex = this.roomInfo.teamList.findIndex(t => t.id === oldTeamId);\n                if (oldTeamIndex > -1) {\n                    //如果之前有在队伍中,需要处理\n                    if (this.roomInfo.freeTeamMinPlayers && this.roomInfo.freeTeamMaxPlayers) {\n                        //是自由队伍的房间\n                        if (arrCount(this.roomInfo.playerList, p => p.teamId === oldTeamId) <= 0) {\n                            //之前队伍已经没人了,则销毁该队伍\n                            arrRemoveItems(this.roomInfo.teamList, t => t.id === oldTeamId);\n                            this.roomInfo.teamList.splice(oldTeamIndex, 1);\n                        }\n                    }\n                }\n            }\n            this.roomRegInfo.emptySeats = RoomHelper.getRoomEmptySeats(this.roomInfo);\n            await Promise.all([\n                this.gameClusterClient.updateRoom(\n                    this.roomRegInfo,\n                    ERoomRegChangedType.PlayerChangeTeam,\n                    playerInfo.playerId,\n                    newTeamId,\n                    oldTeamId\n                ),\n                this.triggerChangePlayerTeam(playerInfo, oldTeamId),\n            ]);\n        }\n\n\n        return Result.buildSucc(null);\n    }\n\n    protected async intenalChangeCustomPlayerStatus(playerId: string, newCustomPlayerStatus: number)\n        : Promise<IResult<IPlayerInfo>> {\n        let playerInfo = this.roomInfo.playerList.find(p => p.playerId === playerId);\n        if (!playerInfo) return Result.buildErr('玩家不在房间中!', ErrorCodes.Exception);\n\n        if (playerInfo.customPlayerStatus !== newCustomPlayerStatus) {\n            let oldVal = playerInfo.customPlayerStatus;\n            playerInfo.customPlayerStatus = newCustomPlayerStatus;\n            //无需等待通知结果,直接返回操作成功\n            this.triggerChangeCustomPlayerStatus(playerInfo, oldVal);\n        }\n        return Result.buildSucc(playerInfo);\n    }\n\n    protected async intenalChangeCustomPlayerProfile(playerId: string, newCustomPlayerProfile: string)\n        : Promise<IResult<IPlayerInfo>> {\n        let playerInfo = this.roomInfo.playerList.find(p => p.playerId === playerId);\n        if (!playerInfo) return Result.buildErr('玩家不在房间中!');\n\n        if (playerInfo.customPlayerProfile !== newCustomPlayerProfile) {\n            let oldVal = playerInfo.customPlayerProfile;\n            playerInfo.customPlayerProfile = newCustomPlayerProfile;\n            this.triggerChangeCustomPlayerProfile(playerInfo, oldVal);\n        }\n\n        return Result.buildSucc(playerInfo);\n    }\n\n    /**\n     * 玩家加入房间，会根据房间等的规则判断是否可以加入\n     *\n     * @public\n     * @param player\n     * @returns\n     */\n    public async joinRoom(player: IPlayer, joinPara: IJoinRoomPara): Promise<IResult<IRoomInfo>> {\n        const ret = await this.internalJoinRoom(player.playerInfo, joinPara);\n        //加入失败,直接返回\n        if (!ret.succ) return Result.buildErr(ret);\n        //加入成功并且要求直接返回成功\n        if (ret.data) return Result.buildSucc(this.roomInfo);\n\n        //当前玩家的数据操作\n        player.authInfo.currRoomId = this.roomInfo.roomId;\n        PlayerAuthHelper.updatePlayerCurrRoomId(player.authInfo.playerToken, player.authInfo.currRoomId);\n\n        return Result.buildSucc(this.roomInfo);\n    }\n\n\n\n    /**\n     * 离开玩家当前所在的房间,如果离开后没人了,房间将被解散，返回房间是否被解散\n     *\n     * @public\n     * @param player\n     * @returns\n     */\n    public async leaveRoom(player: IPlayer): Promise<IResult<null>> {\n        const leavePlayerInfos = await this.internalLeaveRoom(player);\n\n        if (this.roomInfo.playerList.length <= 0) {\n            //房间没人了\n            if (!this.roomInfo.retainEmptyRoomTime) {\n                //没设置保留空房间,则直接解散\n                await this.internalDismissRoom();\n            }\n        } else {\n            //还有人，才需要触发事件\n            leavePlayerInfos.forEach(async playerInfo => {\n                await this.triggerPlayerLeaveRoomNotify(playerInfo);\n            });\n        }\n\n        return Result.buildSucc(null);\n    }\n\n    /**\n     * 解散房间\n     *\n     * @public\n     * @param player 当前玩家,如果是定时解散等没有当前玩家时,可以不传\n     * @returns\n     */\n    public async dismissRoom(player?: IPlayer): Promise<IResult<IRoomInfo>> {\n        if (player && this.roomInfo.ownerPlayerId !== player.playerInfo.playerId) {\n            return Result.buildErr('只有房主才可以解散房间！', ErrorCodes.RoomPermissionDenied);\n        }\n\n        //拷贝一份原有的玩家信息列表(排除自己)，用于做事件通知\n        let notifyPlayerInfos = player ?\n            this.roomInfo.playerList.filter(p => p.playerId !== player.playerInfo.playerId)\n            : [...this.roomInfo.playerList];\n\n        //执行实际的解散逻辑（数据操作）\n        await this.internalDismissRoom();\n\n        //触发事件(不等待)\n        this.triggerDismissRoomNotify(notifyPlayerInfos);\n\n        return Result.buildSucc(this.roomInfo);\n    }\n\n\n    /**\n     * 房主修改房间属性\n     *\n     * @public\n     * @param player 当前玩家\n     * @returns\n     */\n    public async changeRoom(player: IPlayer, changePara: IChangeRoomPara): Promise<IResult<IRoomInfo>> {\n        if (this.roomInfo.ownerPlayerId !== player.playerInfo.playerId) {\n            return Result.buildErr('只有房主才可以修改房间信息！');\n        }\n\n        let changed = false;\n        let regChange = false;\n        if (changePara.roomName) {\n            this.roomInfo.roomName = changePara.roomName;\n            this.roomRegInfo.roomName = changePara.roomName;\n            changed = true;\n        }\n        if (typeof (changePara.isPrivate) !== 'undefined') {\n            this.roomInfo.isPrivate = changePara.isPrivate;\n            this.roomRegInfo.isPrivate = this.roomInfo.isPrivate ? 1 : 0;\n            changed = true;\n            regChange = true;\n        }\n        if (typeof (changePara.privateRoomJoinMode) !== 'undefined') {\n            this.roomInfo.privateRoomJoinMode = changePara.privateRoomJoinMode;\n            this.roomRegInfo.privateRoomJoinMode = changePara.privateRoomJoinMode;\n            changed = true;\n            regChange = true;\n        }\n        if (typeof (changePara.privateRoomPassword) !== 'undefined') {\n            this.roomRegInfo.privateRoomPassword = changePara.privateRoomPassword;\n            changed = true;\n            regChange = true;\n        }\n        if (typeof (changePara.customProperties) !== 'undefined') {\n            this.roomInfo.customProperties = changePara.customProperties;\n            changed = true;\n        }\n        if (changed) {\n            if (regChange) {\n                await Promise.all([\n                    this.gameClusterClient.updateRoom(\n                        this.roomRegInfo,\n                        ERoomRegChangedType.ChangeInfo\n                    ),\n                ]);\n            }\n            //触发事件\n            this.triggerChangeRoomNotify();\n        }\n\n        return Result.buildSucc(this.roomInfo);\n    }\n    /**\n     *玩家修改自己的自定义状态\n     *\n     * @param player\n     * @param newCustomPlayerStatus\n     * @param [robotPlayerId] 可以指定自己的房间机器人\n     * @returns\n     */\n    public async changeCustomPlayerStatus(player: IPlayer, newCustomPlayerStatus: number, robotPlayerId?: string): Promise<IResult<IPlayerInfo>> {\n        let playerId: string;\n        if (robotPlayerId) {\n            if (!player.roomRobotPlayers.has(robotPlayerId)) {\n                return Result.buildErr('非可操作玩家!', ErrorCodes.Exception);\n            }\n            playerId = robotPlayerId;\n        } else {\n            playerId = player.playerInfo.playerId;\n        }\n        return await this.intenalChangeCustomPlayerStatus(playerId, newCustomPlayerStatus);\n    }\n    /**\n     *玩家修改自己的自定义属性\n     *\n     * @param player\n     * @param newCustomPlayerProfile\n     * @param [robotPlayerId] 可以指定自己的房间机器人\n     * @returns\n     */\n    public async changeCustomPlayerProfile(player: IPlayer, newCustomPlayerProfile: string, robotPlayerId?: string): Promise<IResult<IPlayerInfo>> {\n        let playerId: string;\n        if (robotPlayerId) {\n            if (!player.roomRobotPlayers.has(robotPlayerId)) {\n                return Result.buildErr('非可操作玩家!', ErrorCodes.Exception);\n            }\n            playerId = robotPlayerId;\n        } else {\n            playerId = player.playerInfo.playerId;\n        }\n        return await this.intenalChangeCustomPlayerProfile(playerId, newCustomPlayerProfile);\n    }\n    /**\n     *玩家修改自己所在队伍\n     *\n     * @param player\n     * @param newTeamId\n     * @param [robotPlayerId] 可以指定自己的房间机器人\n     * @returns\n     */\n    public async changePlayerTeam(player: IPlayer, newTeamId?: string, robotPlayerId?: string): Promise<IResult<IRoomInfo>> {\n        let playerInfo: IPlayerInfo | undefined;\n        if (robotPlayerId) {\n            playerInfo = player.roomRobotPlayers.get(robotPlayerId);\n            if (!playerInfo) {\n                return Result.buildErr('非可操作玩家!', ErrorCodes.Exception);\n            }\n        } else {\n            playerInfo = player.playerInfo;\n        }\n\n        let ret = await this.internalChangePlayerTeam(playerInfo, newTeamId);\n        if (!ret.succ) return Result.buildErr(ret.err, ret.code);\n        return Result.buildSucc(this.roomInfo);\n    }\n\n\n    /**\n     * 开始游戏帧同步\n     *\n     * @public\n     */\n    public async startGameFrameSync(player: IPlayer): Promise<void> {\n        this.roomInfo.startGameTime = Date.now();\n        this.roomInfo.frameSyncState = EFrameSyncState.START;\n        //await等通知消息都发了,再启动游戏的帧同步\n        await this.triggerStartFrameSyncNotify(player.playerInfo);\n        this.game.startGame();\n\n        //根据当前房间情况去自动开启或关闭招人匹配\n        await this.autoSetRoomJoinUsMatch();\n    }\n\n    /**\n     * 停止游戏帧同步\n     *\n     * @public\n     */\n    public async stopGameFrameSync(player: IPlayer): Promise<void> {\n        this.game.stopGame();\n        this.roomInfo.frameSyncState = EFrameSyncState.STOP;\n        await this.triggerStopFrameSyncNotify(player.playerInfo);\n\n        //根据当前房间情况去自动开启或关闭招人匹配\n        await this.autoSetRoomJoinUsMatch();\n    }\n\n    /**\n     * 玩家输入帧\n     * @param player \n     * @param inpFrameType \n     * @param [setOthersProp] \n     * @param [robotPlayerId] 可以指定自己的房间机器人\n     * @returns  \n     */\n    public playerInpFrame(player: IPlayer, inpFrameType: EPlayerInputFrameType,\n        setOthersProp?: (inpFrame: IFramePlayerInput) => void, robotPlayerId?: string) {\n        let playerInfo: IPlayerInfo | undefined;\n        if (robotPlayerId) {\n            playerInfo = player.roomRobotPlayers.get(robotPlayerId);\n            if (!playerInfo) {\n                return Result.buildErr('非可操作玩家!', ErrorCodes.Exception);\n            }\n        } else {\n            playerInfo = player.playerInfo;\n        }\n        return this.game.playerInpFrame(playerInfo, inpFrameType, setOthersProp);\n    }\n\n\n    /**\n     * 发起房间所有玩家匹配请求\n     * 请求成功即返回,同时房间中的所有玩家会收到通知\n     * 匹配有结果了还会收到消息通知, 并且可由一个玩家调用QueryMatch等待完整匹配结果\n     *\n     * @public\n     * @param player\n     * @param matchParams\n     * @returns\n     */\n    public async requestMatch(player: IPlayer, matchParams: IMatchParamsFromRoomAllPlayer)\n        : Promise<IResult<string>> {\n        if (this.roomInfo.allPlayerMatchReqId) {\n            return Result.buildErr('当前在匹配中!要重新请求必须先取消!', ErrorCodes.MatchRequestCancelled);\n        }\n        //TODO: 发起后又加入玩家怎么算? 还是改成房间发起请求后是否停止加人? 如果停止加人是否设置一个停止原因?用于有人加入时返回消息\n\n        if (!matchParams.matchFromInfo) matchParams.matchFromInfo = {};\n        let matchReq = matchParams as IMatchRequest;\n        let matchFromInfo = matchReq.matchFromInfo as IMatchFromRoomAllPlayersOnServer;\n        //这里需要把当前房间中所有玩家id更新进去,对于服务器来说是多玩家匹配\n        matchFromInfo.playerIds = this.roomInfo.playerList.map(p => p.playerId);\n\n        this.onRoomAllPlayersMatchResult = async (matchResult) => {\n            this.onRoomAllPlayersMatchResult = undefined;\n            this.roomInfo.allPlayerMatchReqId = undefined;\n            if (matchResult.succ) {\n                //匹配结果是成功的,需要通知单独通知每个玩家自己的结果\n                let notifyTasks: Promise<any>[] = [];\n                for (let playerResult of matchResult.data.matchPlayerResults) {\n                    let conn = this.gameConnMgr.getPlayerConn(playerResult.playerId);\n                    if (!conn) continue;\n                    let playerMatchResult: IMatchPlayerResultWithServer = {\n                        gameServerUrl: matchResult.data.gameServerUrl,\n                        roomId: matchResult.data.roomId,\n                        teamId: playerResult.teamId,\n                    };\n                    notifyTasks.push(conn.sendMsg('NotifyRoomAllPlayersMatchResult', {\n                        roomInfo: this.roomInfo,\n                        matchResult: playerMatchResult,\n                    }));\n                }\n                await Promise.all(notifyTasks);\n            } else {\n                //匹配失败的,则结果一样,直接广播\n                await this.gameWsServer.broadcastMsg('NotifyRoomAllPlayersMatchResult', {\n                    roomInfo: this.roomInfo,\n                    errMsg: matchResult.err,\n                    errCode: matchResult.code,\n                }, this.onlinePlayerConns.connections);\n            }\n            this.onRoomAllPlayersMatchResultOther?.call(this, matchResult);\n        };\n        let reqRet = await this.matchReqTerminal.requestMatch(player.authInfo.appId, matchReq,\n            async (matchResult) => {\n                //匹配结果返回了(成功或失败)\n                this.onRoomAllPlayersMatchResult?.call(this, matchResult);\n            }\n        );\n        if (!reqRet.succ) {\n            //请求匹配失败了,直接返回失败\n            return reqRet;\n        }\n\n        this.roomInfo.allPlayerMatchReqId = reqRet.data;\n\n        //匹配请求正常发起了,通知相关玩家\n        await this.gameWsServer.broadcastMsg('NotifyRoomAllPlayersMatchStart', {\n            roomInfo: this.roomInfo,\n            matchReqId: reqRet.data,\n            matchParams: matchParams,\n            reqPlayerId: player.playerInfo.playerId,\n        }, this.onlinePlayerConns.connections);\n\n        return reqRet;\n    }\n\n    /**\n     * 取消匹配请求\n     * 如果提交成功, 将会由匹配服务器根据请求顺序来决定是否成功取消\n     * 如果成功取消,则会触发匹配结果(通知+queryMatch),结果为\"请求被取消\"[code=ErrorCodes.MatchRequestCancelled]\n     * 如果没取消成功,说明在取消之前,匹配服务器已经匹配完成,通知过来并发了,所以紧接着会收到成功的匹配结果(通知+queryMatch)\n     *\n     * @param player\n     * @returns\n     */\n    public async cancelMatch(player: IPlayer): Promise<IResult<null>> {\n        if (!this.roomInfo.allPlayerMatchReqId) {\n            return Result.buildErr('当前房间未发起匹配!', ErrorCodes.MatchRequestCancelled);\n        }\n\n        let reqRet = await this.matchReqTerminal\n            .cancelMatch(player.authInfo.appId, this.roomInfo.allPlayerMatchReqId, player.playerInfo.playerId);\n\n        return Result.transition(reqRet, () => null);\n    }\n\n    /**\n     * 查询匹配结果, 会等到有结果了才返回!\n     * 注意: 同时只能只有一个玩家进行查询等待,一般使用通知来获取结果即可\n     *\n     * @param player\n     * @returns \n     */\n    public async queryMatch(player: IPlayer): Promise<IResult<IMatchResult>> {\n        if (!this.roomInfo.allPlayerMatchReqId) {\n            return Result.buildErr('当前房间没发起匹配!', ErrorCodes.MatchRequestCancelled);\n        }\n        if (this.onRoomAllPlayersMatchResultOther) {\n            return Result.buildErr('同时只能一个玩家等待完整匹配结果!', ErrorCodes.MatchRequestCancelled);\n        }\n        let queryTask = new Promise<IResult<IMatchResult>>(async (resolve) => {\n            let timeout = setTimeout(() => {\n                //防止之后各种意外导致都没触发,这里保底\n                this.onRoomAllPlayersMatchResult?.call(this, Result.buildErr('查询超时!', ErrorCodes.MatchQueryTimeout));\n            }, 70000);\n            this.onRoomAllPlayersMatchResultOther = (matchResult) => {\n                //防止重复触发,置空\n                this.onRoomAllPlayersMatchResultOther = undefined;\n                clearTimeout(timeout);\n                resolve(matchResult);\n            };\n            let resultRet = await this.matchReqTerminal\n                .queryMatch(player.authInfo.appId, this.roomInfo.allPlayerMatchReqId!);\n            if (resultRet) {\n                //既然直接查询出结果,那么直接触发吧\n                this.onRoomAllPlayersMatchResult?.call(this, resultRet);\n            }\n        });\n        let queryRet = await queryTask;\n        return queryRet;\n    }\n\n\n    /**\n     * 玩家创建房间机器人(退出房间会同步退出)\n     * @param player \n     * @param createPa \n     * @param [teamId] \n     * @returns room robot \n     */\n    public async createRoomRobot(player: IPlayer, createPa: IPlayerInfoPara, teamId?: string): Promise<IResult<IPlayerInfo>> {\n\n        let robotInfo: IPlayerInfo = {\n            playerId: buildPlayerRobotId(player.playerInfo.playerId),\n            showName: createPa.showName ?? `${player.authInfo.showName}R${player.roomRobotPlayers.size}`,\n            customPlayerStatus: createPa.customPlayerStatus ?? 0,\n            customPlayerProfile: createPa.customPlayerProfile ?? '',\n            isRobot: true,\n            networkState: ENetworkState.ONLINE,\n        };\n\n        const ret = await this.internalJoinRoom(robotInfo, { roomId: this.roomInfo.roomId, teamId }, player.playerInfo);\n        //加入失败,直接返回\n        if (!ret.succ) return Result.buildErr(ret);\n\n        //机器人加入到玩家连接的房间机器人里\n        player.roomRobotPlayers.set(robotInfo.playerId, robotInfo);\n\n        return Result.buildSucc(robotInfo);\n    }\n\n    /**\n     * 玩家的指定房间机器人退出房间(即销毁)\n     * @param player \n     * @param robotPlayerId \n     * @returns  \n     */\n    public async roomRobotLeave(player: IPlayer, robotPlayerId: string): Promise<IResult<IPlayerInfo>> {\n        const robotInfo = player.roomRobotPlayers.get(robotPlayerId);\n        if (!robotInfo) return Result.buildErr('非可操作机器人!', ErrorCodes.Exception);\n        const teamId = robotInfo.teamId;\n        this.internalLeaveRoomData(robotInfo);\n\n        //移掉这个机器人\n        let tmpIds = new Set([...player.playerInfo.roomRobotIds ?? []]);\n        tmpIds.delete(robotPlayerId);\n        player.playerInfo.roomRobotIds = Array.from(tmpIds);\n\n        //通知玩家退出\n        await this.triggerPlayerLeaveRoomNotify(robotInfo);\n\n        //更新房间注册信息\n        this.roomRegInfo.teamsPlayerIds = this.buildTeamsPlayerIds(this.roomInfo.playerList);\n        this.roomRegInfo.emptySeats = RoomHelper.getRoomEmptySeats(this.roomInfo);\n        await Promise.all([\n            this.gameClusterClient.updateRoom(\n                this.roomRegInfo,\n                ERoomRegChangedType.PlayerJoinRoom,\n                robotPlayerId,\n                teamId,\n            ),\n            //根据当前房间情况去自动开启或关闭招人匹配\n            this.autoSetRoomJoinUsMatch(),\n        ]);\n\n        return Result.buildSucc(robotInfo);\n    }\n}"]}